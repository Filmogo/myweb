<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>‚≠ê Tetris Club ‚Äî Mobile</title>
<meta name="theme-color" content="#0b1226" />
<style>
  :root{ --app-h:100svh; --bg:#0b1226; --bg2:#0f1f4a; --text:#e8f0ff; --muted:#a9b8ff; --line:#1a2a56; }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  html,body{height:100%}
  body{
    margin:0;
    height:var(--app-h);
    min-height:100svh; /* –Ω–æ–≤—ã–π iOS —é–Ω–∏—Ç */
    padding-top: env(safe-area-inset-top, 0);
    padding-bottom: env(safe-area-inset-bottom, 0);
    overscroll-behavior:none;
    background:
      radial-gradient(1200px 800px at 15% 10%, var(--bg2), transparent),
      radial-gradient(900px 700px at 80% 90%, #102054, transparent),
      linear-gradient(180deg, var(--bg), var(--bg));
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Arial;
    display:flex;align-items:center;justify-content:center;
  }

  .app{ width:min(1100px,100%); height:100%; display:grid; grid-template-rows:auto 1fr auto; gap:12px; padding:12px; }
  .top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .brand{ display:flex; gap:10px; align-items:center; font-weight:900; letter-spacing:.3px }
  .stat{ display:flex; gap:8px; flex-wrap:wrap; }
  .pill{ font-size:12px; padding:6px 10px; border-radius:999px; background:#0a1a38; color:var(--muted); border:1px solid var(--line); }
  .pill b{color:#fff}

  .main{ display:grid; grid-template-columns: minmax(260px, 1fr) 360px; gap:12px; height:100%; }
  @media (max-width: 900px){ .main{ grid-template-columns:1fr; } }

  .board{
    position:relative; margin:auto; width:min(92vw, 520px);
    /* –≤—ã—Å–æ—Ç—É —Å—á–∏—Ç–∞–µ–º –≤ JS, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –±–∞–≥–æ–≤ aspect-ratio –Ω–∞ iOS TG */
    background:#0a1633; border:1px solid var(--line); border-radius:12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 40px rgba(114,255,210,.05);
    overflow:hidden;
  }
  canvas{ width:100%; height:100%; display:block; image-rendering: pixelated; touch-action:none; }

  .side{ display:flex; flex-direction:column; gap:12px; height:100%; }
  .card{
    background: linear-gradient(180deg, rgba(20,36,80,.55), rgba(10,18,40,.55));
    border:1px solid var(--line); border-radius:12px; padding:12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.3);
  }
  .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .next{ display:grid; grid-template-columns:repeat(4,18px); grid-auto-rows:18px; gap:2px; padding:8px; background:#0a1a38; border:1px solid var(--line); border-radius:8px; width:max-content }
  .cell{ width:18px; height:18px; background:#142a5a; border-radius:4px; }

  .btn{ padding:10px 12px; border:none; border-radius:10px; font-weight:800; cursor:pointer; }
  .primary{ background:linear-gradient(180deg,#6aa3ff,#4b87ff); color:#05122c; }
  .ghost{ background:transparent; border:1px solid var(--line); color:#a9b8ff; }
  .ok{ background:linear-gradient(180deg,#76ffb0,#39d681); color:#05301a; }

  .shop-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; border:1px solid var(--line); border-radius:10px; padding:10px; background:#0b1b3d; }
  .tiny{ font-size:12px; color:#a9b8ff }

  .tabs{ position:fixed; left:0; right:0; bottom:env(safe-area-inset-bottom, 0); display:grid; grid-template-columns:1fr 1fr 1fr; background:#0a132b; border-top:1px solid var(--line); padding:8px; gap:10px; }
  .tabbtn{ display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px 6px; border-radius:12px; border:1px solid var(--line); background:#0a1a38; color:#a9b8ff; font-weight:700; cursor:pointer; }
  .tabbtn.active{ color:#fff; border-color:#2a4a86; box-shadow: inset 0 0 24px rgba(114,255,210,.08) }

  /* –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
  .controls{
    position:absolute; left:0; right:0; bottom:8px; display:flex; justify-content:space-between; padding:8px;
    pointer-events:none;
  }
  .ctrlgroup{ display:flex; gap:8px; }
  .ctrlbtn{ pointer-events:auto; background:#0a1a38; border:1px solid var(--line); color:#fff; border-radius:12px; padding:10px 12px; font-weight:900; opacity:.95 }
  .ctrlbtn:active{ transform:scale(.97) }

  /* –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω */
  .overlay{ position:absolute; inset:0; display:grid; place-items:center; background:rgba(5,10,25,.6); backdrop-filter: blur(4px); }
  .modal{ background:#0a1a38; border:1px solid var(--line); border-radius:16px; padding:16px; width:min(420px,90vw); text-align:center; box-shadow: 0 20px 60px rgba(0,0,0,.5); }

  .toast{ position:fixed; left:50%; bottom:calc(22px + env(safe-area-inset-bottom, 0)); transform:translateX(-50%) translateY(20px); background:#0b1a3a; border:1px solid var(--line); padding:10px 14px; border-radius:12px; opacity:0; transition: opacity .2s, transform .2s; pointer-events:none; }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }
</style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">üß© <span>Tetris Club</span></div>
      <div class="stat">
        <div class="pill">—É—Ä–æ–≤–µ–Ω—å: <b id="level">1</b></div>
        <div class="pill">–æ—á–∫–∏: <b id="score">0</b></div>
        <div class="pill">‚≠ê –∑–≤—ë–∑–¥—ã: <b id="stars">0</b></div>
        <div class="pill">–∑–∞–º–µ–¥–ª–µ–Ω–∏—è: <b id="slowCharges">0</b></div>
      </div>
    </div>

    <div class="main">
      <!-- –ò–ì–†–û–í–û–ï –ü–û–õ–ï -->
      <div class="board" id="board">
        <canvas id="game" width="200" height="400"></canvas>

        <!-- –°—Ç–∞—Ä—Ç -->
        <div class="overlay" id="startOverlay">
          <div class="modal">
            <h3 style="margin:6px 0 10px">Tetris Club</h3>
            <div class="tiny" style="margin-bottom:10px">‚Üê/‚Üí, ‚Üë (–ø–æ–≤–æ—Ä–æ—Ç), ‚Üì, Space (—Ö–∞—Ä–¥-–¥—Ä–æ–ø). –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ ‚Äî –∫–Ω–æ–ø–∫–∏ –∏ —Å–≤–∞–π–ø—ã.</div>
            <button class="btn ok" id="startBtn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
          </div>
        </div>

        <!-- –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
        <div class="controls">
          <div class="ctrlgroup">
            <button class="ctrlbtn" id="leftBtn">‚Üê</button>
            <button class="ctrlbtn" id="rightBtn">‚Üí</button>
            <button class="ctrlbtn" id="rotateBtn">‚§æ</button>
          </div>
          <div class="ctrlgroup">
            <button class="ctrlbtn" id="downBtn">‚Üì</button>
            <button class="ctrlbtn" id="dropBtn">‚§ì</button>
            <button class="ctrlbtn" id="pauseBtn">‚è∏</button>
          </div>
        </div>
      </div>

      <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
      <div class="side">
        <div class="card">
          <div class="row" style="margin-bottom:8px"><div><b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</b></div></div>
          <div class="tiny">‚Üê/‚Üí ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ, ‚Üë ‚Äî –ø–æ–≤–æ—Ä–æ—Ç, ‚Üì ‚Äî —É—Å–∫–æ—Ä–µ–Ω–∏–µ, Space ‚Äî —Ö–∞—Ä–¥-–¥—Ä–æ–ø, ‚è∏ ‚Äî –ø–∞—É–∑–∞</div>
          <div class="row" style="margin-top:10px">
            <div class="row" style="gap:8px">
              <div class="tiny">–°–ª–µ–¥—É—é—â–∞—è —Ñ–∏–≥—É—Ä–∞:</div>
              <div class="next" id="nextBox"></div>
            </div>
            <button class="btn primary" id="slowBtn" disabled>üê¢ –ó–∞–º–µ–¥–ª–∏—Ç—å (60—Å)</button>
          </div>
        </div>

        <div class="card">
          <div class="row" style="margin-bottom:8px"><div><b>–ú–∞–≥–∞–∑–∏–Ω</b></div></div>
          <div class="shop-row">
            <div>
              <div><b>üê¢ –ó–∞—Ä—è–¥ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è</b></div>
              <div class="tiny">–ó–∞–º–µ–¥–ª—è–µ—Ç –ø–∞–¥–µ–Ω–∏–µ –Ω–∞ 60 —Å–µ–∫</div>
              <div class="tiny">–¶–µ–Ω–∞: <b>30‚≠ê</b></div>
            </div>
            <button class="btn primary" id="buySlowBtn">–ö—É–ø–∏—Ç—å –∑–∞ 30‚≠ê</button>
          </div>
          <div class="shop-row">
            <div>
              <div><b>‚≠ê –ö—É–ø–∏—Ç—å –∑–≤—ë–∑–¥—ã</b></div>
              <div class="tiny">–†–µ–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –≤ Telegram (invoice)</div>
            </div>
            <button class="btn ok" id="buyStarsBtn">–ö—É–ø–∏—Ç—å ‚≠ê</button>
          </div>
        </div>

        <div class="card">
          <div class="row" style="margin-bottom:8px">
            <div><b>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</b></div>
            <button class="btn ghost" id="syncLB">‚Üª</button>
          </div>
          <div id="lb"></div>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tabbtn active" data-tab="play">üéÆ –ò–≥—Ä–∞</button>
      <button class="tabbtn" data-tab="shop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
      <button class="tabbtn" data-tab="lb">üèÜ –õ–∏–¥–µ—Ä—ã</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  /* ===== iOS/Telegram –≤—ã—Å–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞ ===== */
  function setAppHeight(){
    const vv = window.visualViewport;
    const h = vv ? vv.height : window.innerHeight;
    document.documentElement.style.setProperty('--app-h', h + 'px');
  }
  setAppHeight();
  window.addEventListener('resize', setAppHeight);
  window.addEventListener('orientationchange', setAppHeight);
  setTimeout(setAppHeight, 80);

  // Telegram expand
  try{ if(window.Telegram?.WebApp){ Telegram.WebApp.ready?.(); Telegram.WebApp.expand?.(); Telegram.WebApp.disableVerticalSwipes?.(); } }catch(e){}

  /* ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∫—É–ø–∫–∏ –∑–≤—ë–∑–¥ (–≤—Å—Ç–∞–≤—å —Å–≤–æ—é —Å—Å—ã–ª–∫—É –∏–Ω–≤–æ–π—Å–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ) ====== */
  const INVOICE_URL = ""; // –ø—Ä–∏–º–µ—Ä: "https://t.me/your_bot?start=invoice_abc123"

  /* ====== –≠–ª–µ–º–µ–Ω—Ç—ã ====== */
  const $=s=>document.querySelector(s);
  const board=$('#board'), canvas=$('#game'), ctx=canvas.getContext('2d');
  const elLevel=$('#level'), elScore=$('#score'), elStars=$('#stars'), elSlowCharges=$('#slowCharges');
  const elNext=$('#nextBox'), elLB=$('#lb'), elSyncLB=$('#syncLB'), elToast=$('#toast');
  const elStartOverlay=$('#startOverlay'), elStartBtn=$('#startBtn');
  const elLeft=$('#leftBtn'), elRight=$('#rightBtn'), elRotate=$('#rotateBtn'), elDown=$('#downBtn'), elDrop=$('#dropBtn'), elPause=$('#pauseBtn');
  const elSlow=$('#slowBtn'), elBuySlow=$('#buySlowBtn'), elBuyStars=$('#buyStarsBtn');

  /* ====== –ü–æ–¥–≥–æ–Ω—è–µ–º –∫–∞–Ω–≤–∞—Å –∫ –¥–æ—Å–∫–µ (10:20) ====== */
  function sizeBoard(){
    // –≤—ã—Å–æ—Ç–∞ = min(–≤—ã—Å–æ—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏, 1.6 * —à–∏—Ä–∏–Ω–∞) —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ –≤—Å—ë
    const w = board.clientWidth;
    const maxH = board.parentElement.clientHeight; // –∫–æ–ª–æ–Ω–∫–∞
    const h = Math.min(Math.floor(w*2), Math.floor(maxH));
    board.style.height = h+'px';
    // —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –∫–∞–Ω–≤–∞—Å–∞ —Å —É—á—ë—Ç–æ–º DPR
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
    canvas.width = 200*dpr; canvas.height = 400*dpr;
    canvas.style.width = '100%'; canvas.style.height = '100%';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  sizeBoard();
  new ResizeObserver(sizeBoard).observe(board);
  window.addEventListener('orientationchange', ()=>setTimeout(sizeBoard, 120));

  /* ====== –ò–≥—Ä–∞ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ, –Ω–æ —É–∫–æ—Ä–æ—á–µ–Ω–æ –¥–æ –Ω—É–∂–Ω–æ–≥–æ) ====== */
  const W=10,H=20,CELL=20;
  const COLORS={ I:'#72ffd2', J:'#6aa3ff', L:'#ffd36a', O:'#72ffa6', S:'#ffad6a', T:'#e6a8ff', Z:'#ff6a89' };
  const SHAPES={ I:[[1,1,1,1]], J:[[1,0,0],[1,1,1]], L:[[0,0,1],[1,1,1]], O:[[1,1],[1,1]], S:[[0,1,1],[1,1,0]], T:[[0,1,0],[1,1,1]], Z:[[1,1,0],[0,1,1]] };
  const PIECES=Object.keys(SHAPES);

  const state={
    grid: grid(W,H),
    cur:null, next: piece(),
    level:+(localStorage.getItem('tetris-level')||1),
    score:+(localStorage.getItem('tetris-score')||0),
    stars:+(localStorage.getItem('tetris-stars')||0),
    slow:+(localStorage.getItem('tetris-slow')||0),
    hi:+(localStorage.getItem('tetris-hi')||0),
    uid: localStorage.getItem('tetris-uid') || ('u-'+Math.random().toString(16).slice(2)),
    name: localStorage.getItem('tetris-name') || '–∏–≥—Ä–æ–∫',
    paused:true, over:false, started:false,
    tickBase:800, tickSlow:1400, slowActive:false, slowUntil:0, lastFall:0,
    touch:{}
  };
  save(); renderUI(); drawNext(); renderLB(); showStart(); requestAnimationFrame(loop);

  function grid(w,h){ return Array.from({length:h},()=>Array(w).fill(null)); }
  function piece(){ const t=PIECES[Math.floor(Math.random()*PIECES.length)]; return {type:t, mtx: clone(SHAPES[t]), color:COLORS[t]}; }
  function clone(m){ return m.map(r=>r.slice()); }
  function rot(m){ const h=m.length,w=m[0].length,out=Array.from({length:w},()=>Array(h).fill(0)); for(let y=0;y<h;y++) for(let x=0;x<w;x++) out[x][h-1-y]=m[y][x]; return out; }
  function collide(g,p){ const {x,y,mtx}=p; for(let j=0;j<mtx.length;j++) for(let i=0;i<mtx[j].length;i++) if(mtx[j][i]){ const gx=x+i, gy=y+j; if(gx<0||gx>=W||gy>=H) return true; if(gy>=0 && g[gy][gx]) return true; } return false; }
  function merge(g,p){ const {x,y,mtx,color}=p; for(let j=0;j<mtx.length;j++) for(let i=0;i<mtx[j].length;i++) if(mtx[j][i]&&y+j>=0) g[y+j][x+i]=color; }
  function clearLines(){ let n=0; for(let y=H-1;y>=0;){ if(state.grid[y].every(Boolean)){ state.grid.splice(y,1); state.grid.unshift(Array(W).fill(null)); n++; } else y--; } if(n){ const table=[0,100,300,500,800]; const add=(table[n]||1000)*state.level; state.score+=add; if(state.score>state.hi) state.hi=state.score; save(); renderUI(); levelUp(); } }
  function levelUp(){ const need=state.level*2000; if(state.score>=need){ state.level++; state.stars+=3; toast('–£—Ä–æ–≤–µ–Ω—å '+state.level+' ‚≠ê+3'); save(); renderUI(); } }
  function newPiece(){ state.cur={x:Math.floor(W/2)-2,y:-2,...state.next}; state.next=piece(); if(collide(state.grid,state.cur)){ state.over=true; state.paused=true; state.started=false; upsertSelfLB(); renderLB(); showStart(); } drawNext(); }

  function draw(){
    // —Ñ–æ–Ω
    ctx.fillStyle='#0a1633'; ctx.fillRect(0,0,canvas.width,canvas.height);
    // —Å–µ—Ç–∫–∞ + –∑–∞–ø–æ–ª–Ω—è–µ–º
    for(let y=0;y<H;y++) for(let x=0;x<W;x++){ const c=state.grid[y][x]; if(c) cell(x,y,c); else { ctx.strokeStyle='rgba(26,42,86,.18)'; ctx.strokeRect(x*CELL,y*CELL,CELL,CELL); } }
    if(state.cur){ const {x,y,mtx,color}=state.cur; for(let j=0;j<mtx.length;j++) for(let i=0;i<mtx[j].length;i++) if(mtx[j][i]&&y+j>=0) cell(x+i,y+j,color); }
    if(state.slowActive){ const left=Math.max(0,state.slowUntil-performance.now()); ctx.fillStyle='rgba(114,255,166,.08)'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#72ffa6'; ctx.font='bold 12px system-ui'; ctx.fillText('–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ: '+(left/1000|0)+'—Å',6,14); if(left<=0){ state.slowActive=false; $('#slowBtn').disabled = state.slow<=0 || !state.started; } }
  }
  function cell(x,y,c){ ctx.fillStyle=c; ctx.fillRect(x*CELL,y*CELL,CELL,CELL); ctx.fillStyle='rgba(255,255,255,.15)'; ctx.fillRect(x*CELL,y*CELL,CELL,4); ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.strokeRect(x*CELL,y*CELL,CELL,CELL); }
  function drawNext(){ const m=state.next.mtx,h=m.length,w=m[0].length; const box=$('#nextBox'); box.innerHTML=''; for(let y=0;y<4;y++) for(let x=0;x<4;x++){ const d=document.createElement('div'); d.className='cell'; if(y<h&&x<w&&m[y][x]) d.style.background=state.next.color; box.appendChild(d); } }
  function renderUI(){ $('#level').textContent=state.level; $('#score').textContent=state.score.toLocaleString('ru-RU'); $('#stars').textContent=state.stars; $('#slowCharges').textContent=state.slow; $('#slowBtn').disabled = state.slow<=0 || state.slowActive || !state.started; }
  function toast(m,ms=1200){ elToast.textContent=m; elToast.classList.add('show'); clearTimeout(toast._t); toast._t=setTimeout(()=>elToast.classList.remove('show'),ms); }
  function delay(){ const base=state.slowActive?state.tickSlow:state.tickBase; const k=Math.max(0.15,1-(state.level-1)*0.08); return base*k|0; }

  function loop(ts){
    if(!state.started){ draw(); requestAnimationFrame(loop); return; }
    if(state.paused||state.over){ draw(); requestAnimationFrame(loop); return; }
    if(!state.lastFall) state.lastFall=ts;
    if(ts-state.lastFall>=delay()){ state.lastFall=ts; state.cur.y++; if(collide(state.grid,state.cur)){ state.cur.y--; merge(state.grid,state.cur); clearLines(); newPiece(); } }
    draw(); requestAnimationFrame(loop);
  }

  /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
  function move(dx){ if(!state.started||state.paused||state.over) return; state.cur.x+=dx; if(collide(state.grid,state.cur)) state.cur.x-=dx; }
  function rotateCur(){ if(!state.started||state.paused||state.over) return; const p=state.cur.mtx; state.cur.mtx=rot(p); if(collide(state.grid,state.cur)){ state.cur.x++; if(collide(state.grid,state.cur)){ state.cur.x-=2; if(collide(state.grid,state.cur)){ state.cur.x++; state.cur.mtx=p; } } } }
  function soft(){ if(!state.started||state.paused||state.over) return; state.cur.y++; if(collide(state.grid,state.cur)) state.cur.y--; else { state.score+=1; renderUI(); } }
  function hard(){ if(!state.started||state.paused||state.over) return; let d=0; while(true){ state.cur.y++; if(collide(state.grid,state.cur)){ state.cur.y--; break; } d++; } state.score+=2*d; renderUI(); merge(state.grid,state.cur); clearLines(); newPiece(); draw(); }
  function togglePause(){ if(!state.started) return; state.paused=!state.paused; elPause.textContent=state.paused?'‚ñ∂Ô∏è':'‚è∏'; }

  addEventListener('keydown', e=>{
    if(e.code==='ArrowLeft') move(-1);
    else if(e.code==='ArrowRight') move(1);
    else if(e.code==='ArrowUp') rotateCur();
    else if(e.code==='ArrowDown') soft();
    else if(e.code==='Space'){ e.preventDefault(); hard(); }
    else if(e.code==='KeyP') togglePause();
  });

  elLeft.onclick=()=>move(-1); elRight.onclick=()=>move(1); elRotate.onclick=()=>rotateCur(); elDown.onclick=()=>soft(); elDrop.onclick=()=>hard(); elPause.onclick=()=>togglePause();

  // —Å–≤–∞–π–ø—ã/—Ç–∞–ø—ã –ø–æ –∫–∞–Ω–≤–∞—Å—É
  canvas.addEventListener('touchstart', e=>{ const t=e.changedTouches[0]; state.touch={x:t.clientX,y:t.clientY,t:Date.now(),active:true}; e.preventDefault(); }, {passive:false});
  canvas.addEventListener('touchmove', e=>{
    if(!state.touch.active) return;
    const t=e.changedTouches[0], dx=t.clientX-state.touch.x, dy=t.clientY-state.touch.y;
    if(Math.abs(dx)>30 && Math.abs(dx)>Math.abs(dy)){ dx>0?move(1):move(-1); state.touch.x=t.clientX; state.touch.y=t.clientY; }
    if(dy>28){ soft(); state.touch.x=t.clientX; state.touch.y=t.clientY; }
    e.preventDefault();
  }, {passive:false});
  canvas.addEventListener('touchend', e=>{
    const dt=Date.now()-state.touch.t; if(dt<300) rotateCur(); else hard(); state.touch.active=false; e.preventDefault();
  }, {passive:false});

  /* –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –∏ –º–∞–≥–∞–∑–∏–Ω */
  elSlow.onclick=()=>{ if(state.slow<=0||state.slowActive||!state.started) return; state.slow--; state.slowActive=true; state.slowUntil=performance.now()+60000; toast('–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ 60—Å'); save(); renderUI(); };
  elBuySlow.onclick=()=>{ if(state.stars<30){ toast('–ù—É–∂–Ω–æ 30‚≠ê'); return; } state.stars-=30; state.slow++; toast('–ö—É–ø–ª–µ–Ω –∑–∞—Ä—è–¥ üê¢'); save(); renderUI(); };

  elBuyStars.onclick=()=>{
    if(window.Telegram?.WebApp && INVOICE_URL){
      Telegram.WebApp.openInvoice(INVOICE_URL, (status)=>{
        if(status==='paid'){ state.stars+=50; toast('–û–ø–ª–∞—á–µ–Ω–æ: +50‚≠ê'); save(); renderUI(); }
        else if(status==='cancelled'){ toast('–ü–æ–∫—É–ø–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞'); }
        else if(status==='failed'){ toast('–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞'); }
      });
    }else{
      state.stars+=20; toast('–î–µ–º–æ-–ø–æ–∫—É–ø–∫–∞: +20‚≠ê'); save(); renderUI(); // –≤–Ω–µ TG
    }
  };

  /* –õ–∏–¥–µ—Ä–±–æ—Ä–¥ (–ª–æ–∫–∞–ª—å–Ω—ã–π) */
  function bots(){ const b=[{uid:'b1',name:'NeoHam',score:18000},{uid:'b2',name:'Foxy',score:12400},{uid:'b3',name:'ByteCat',score:9300},{uid:'b4',name:'Sakura',score:6800},{uid:'b5',name:'Rider',score:4700}]; localStorage.setItem('tetris-bots',JSON.stringify(b)); return b; }
  function getLB(){ const def=JSON.parse(localStorage.getItem('tetris-bots')||'null')||bots(); const me={uid:state.uid,name:state.name,score:state.hi||state.score}; const list=def.slice(); const i=list.findIndex(r=>r.uid===me.uid); if(i>=0) list[i]=me; else list.push(me); list.sort((a,b)=>b.score-a.score); return list.slice(0,20); }
  function upsertSelfLB(){ localStorage.setItem('tetris-lb', JSON.stringify(getLB())); }
  function renderLB(){ const list=getLB(); elLB.innerHTML=''; list.forEach((r,i)=>{ const d=document.createElement('div'); d.className='lbrow'; const you=r.uid===state.uid; d.innerHTML=`<div>${i+1}</div><div style="display:flex;align-items:center;gap:8px"><div class="avatar">${(r.name||'U')[0].toUpperCase()}</div><div><div><b>${r.name}${you?' (—Ç—ã)':''}</b></div><div class="tiny">${you?'ID: '+state.uid:''}</div></div></div><div><b>${r.score.toLocaleString('ru-RU')}</b></div>`; elLB.appendChild(d); }); }
  elSyncLB.onclick=()=>{ upsertSelfLB(); renderLB(); toast('–õ–∏–¥–µ—Ä–±–æ—Ä–¥ –æ–±–Ω–æ–≤–ª—ë–Ω'); };

  /* –¢–∞–±—ã (–¥–ª—è –º–æ–±–∏–ª—ã) */
  document.querySelectorAll('.tabbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t=btn.dataset.tab;
      document.querySelectorAll('.side .card').forEach((c,i)=> c.style.display = (t==='play'&&i===0)||(t==='shop'&&i===1)||(t==='lb'&&i===2) ? 'block' : 'none');
    });
  });
  (function initTabs(){ const cards=document.querySelectorAll('.side .card'); cards.forEach((c,i)=> c.style.display = i===0 ? 'block' : (innerWidth<900 ? 'none' : 'block')); })();

  /* –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, —Å—Ç–∞—Ä—Ç */
  function save(){ localStorage.setItem('tetris-level',state.level); localStorage.setItem('tetris-score',state.score); localStorage.setItem('tetris-stars',state.stars); localStorage.setItem('tetris-slow',state.slow); localStorage.setItem('tetris-hi',state.hi); localStorage.setItem('tetris-uid',state.uid); localStorage.setItem('tetris-name',state.name); }
  function showStart(){ elStartOverlay.style.display='grid'; }
  function hideStart(){ elStartOverlay.style.display='none'; }
  function start(){ state.grid=grid(W,H); state.over=false; state.paused=false; state.started=true; state.score=0; state.lastFall=0; state.slowActive=false; newPiece(); renderUI(); draw(); }
  elStartBtn.onclick=()=>{ hideStart(); start(); };
</script>
</body>
</html>
