<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>üî• Tap Game ‚Äî Neo</title>
  <meta name="theme-color" content="#0b1226" />

  <style>
    :root{
      --bg:#0b1226;
      --bg-grad1:#0b1226; --bg-grad2:#0f1f4a; --bg-grad3:#0b1226;
      --card:#101a36cc; --card-strong:#0e1730;
      --text:#e8f0ff; --muted:#b3c0ff; --accent:#6aa3ff; --accent2:#72ffd2;
      --warning:#ffd36a; --danger:#ff6a89; --good:#72ffa6;
      --shadow:0 10px 30px rgba(0,0,0,.35), 0 0 40px rgba(80,140,255,.15) inset;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Noto Sans", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 10%, var(--bg-grad2), transparent),
                  radial-gradient(900px 700px at 80% 90%, #102054, transparent),
                  linear-gradient(180deg, var(--bg-grad1), var(--bg-grad3));
      color:var(--text);
      display:flex; align-items:center; justify-content:center;
    }
    .app{
      width:min(1050px,100%);
      padding: clamp(14px, 2.2vw, 24px);
    }
    .hud{
      display:grid; gap:12px; grid-template-columns:1fr auto auto;
      align-items:center; margin-bottom:12px;
    }
    .title{
      font-weight:700; letter-spacing:.5px; display:flex; align-items:center; gap:10px;
      text-shadow:0 2px 18px rgba(114,255,210,.35);
    }
    .badge{
      font-size:12px; padding:4px 8px; border-radius:999px; background: #0a233f; color:var(--accent2);
      border:1px solid #1b3c67; box-shadow: inset 0 0 10px rgba(114,255,210,.2);
    }
    .pill{
      font-size:13px; padding:6px 10px; border-radius:999px; background: #0a1a38; color:var(--muted);
      border: 1px solid #1a2a56;
    }

    .grid{
      display:grid; grid-template-columns:1.2fr .8fr; gap:16px;
    }
    @media (max-width: 880px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:linear-gradient(180deg, rgba(20,36,80,.65), rgba(10,18,40,.65));
      border:1px solid #1a2a56; border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
    }

    /* SCORE PANEL */
    .score{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border-radius:14px; background:rgba(10,20,48,.5); border:1px solid #1a2a56;
    }
    .score .big{
      font-size: clamp(30px, 7vw, 48px);
      font-weight:800; letter-spacing: .4px;
    }
    .muted{ color:var(--muted); font-size:14px }
    .flex{ display:flex; align-items:center; gap:10px }
    .vflex{ display:flex; flex-direction:column; gap:8px }

    /* TAP AREA */
    .tapwrap{
      display:flex; flex-direction:column; align-items:center; gap:16px; margin-top:8px;
    }
    .tap{
      width:min(360px, 75vw); aspect-ratio:1/1; border-radius:32px; border:1px solid #1e3470;
      background:
        radial-gradient(200px 200px at 70% 25%, rgba(112,182,255,.25), transparent),
        radial-gradient(400px 400px at 30% 80%, rgba(114,255,210,.15), transparent),
        linear-gradient(180deg, #1a2d63, #0d1a3b);
      box-shadow: 0 25px 50px rgba(0,0,0,.35), inset 0 -6px 20px rgba(0,0,0,.35), inset 0 0 60px rgba(114,255,210,.07);
      display:grid; place-items:center; cursor:pointer; user-select:none; position:relative;
      transition: transform .06s ease;
      outline: none;
    }
    .tap:active{ transform: scale(.98) }
    .tap .label{
      font-size: clamp(20px, 5.5vw, 28px); color:#eaf2ff; opacity:.92; font-weight:700; letter-spacing:.3px;
      text-align:center;
    }
    .burst{
      position:absolute; inset:0; pointer-events:none; overflow:hidden;
    }
    .bubble{
      position:absolute; font-weight:800; filter: drop-shadow(0 8px 16px rgba(0,0,0,.35));
      animation: pop 700ms ease forwards;
    }
    @keyframes pop{
      0%{ transform: translateY(0) scale(.7); opacity:0 }
      15%{ opacity:1 }
      100%{ transform: translateY(-60px) scale(1.1); opacity:0 }
    }

    /* SHOP */
    .shop .row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px; border:1px solid #1a2a56; border-radius:12px; background: #0c1a3a7a;
    }
    .shop .row + .row { margin-top:10px }
    .shop .title{ font-weight:700 }
    .shop .cost{ color:var(--warning); font-weight:700 }
    .shop button{
      background: linear-gradient(180deg, #6aa3ff, #4b87ff);
      border:none; color:#05122c; padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer;
      box-shadow: 0 8px 20px rgba(80,140,255,.35);
      transition: transform .08s ease, filter .2s ease; min-width:96px;
    }
    .shop button:disabled{ filter: grayscale(1) brightness(.7); cursor:not-allowed; }
    .shop button:not(:disabled):active{ transform: translateY(1px) }
    .tiny{ font-size:12px; color:var(--muted) }

    /* FOOTER / ONLINE */
    .footer{
      margin-top:16px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .online{
      padding:8px 12px; border-radius:999px; border:1px solid #1a2a56; background:#0a1a38;
      display:flex; align-items:center; gap:8px; color:var(--muted);
    }
    .dot{ width:8px; height:8px; border-radius:50%; background: var(--good); box-shadow:0 0 18px var(--good) }
    .controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .ghost{
      background:transparent; border:1px solid #1a2a56; color:var(--muted);
      padding:10px 12px; border-radius:10px; cursor:pointer;
    }

    /* TOAST */
    .toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
      background:#0b1a3a; border:1px solid #1a2a56; color:var(--text); padding:10px 14px; border-radius:12px;
      box-shadow: var(--shadow); opacity:0; transition: opacity .2s, transform .2s;
      z-index:50; pointer-events:none;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }

    /* ACHIEVEMENTS */
    .achv{
      display:flex; gap:10px; flex-wrap:wrap
    }
    .chip{
      border:1px solid #1a2a56; background:#0a1a38; color:var(--muted);
      border-radius:999px; padding:6px 10px; font-size:12px
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="hud">
      <div class="title">
        <span style="font-size:22px">üî• Tap Game ‚Äî Neo</span>
        <span class="badge">v1.0</span>
        <span class="pill" id="saveStatus">–∞–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</span>
      </div>
      <div class="pill">–∫–æ–º–±–æ: <b id="combo">x1.0</b></div>
      <div class="pill">—É—Ä–æ–≤–µ–Ω—å: <b id="level">1</b></div>
    </div>

    <div class="grid">
      <!-- LEFT: GAME -->
      <div class="card vflex">

        <div class="score">
          <div class="vflex">
            <div class="muted">–æ—á–∫–∏</div>
            <div class="big" id="score">0</div>
          </div>
          <div class="vflex">
            <div class="muted">–∑–∞ —Ç–∞–ø</div>
            <div class="big" id="perTap">+1</div>
          </div>
          <div class="vflex">
            <div class="muted">–≤ —Å–µ–∫.</div>
            <div class="big" id="perSec">0</div>
          </div>
        </div>

        <div class="tapwrap">
          <button class="tap" id="tapBtn" aria-label="–ñ–º–∏!">
            <div class="label">
              –ñ–ú–ò!
              <div class="tiny" id="tapHint">–º–æ—â–Ω–µ–µ —Å –∫–æ–º–±–æ</div>
            </div>
            <div class="burst" id="burst"></div>
          </button>

          <div class="achv" id="achv"></div>
        </div>

      </div>

      <!-- RIGHT: SHOP -->
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px">
          <div class="title" style="font-size:18px">–ú–∞–≥–∞–∑–∏–Ω –∞–ø–≥—Ä–µ–π–¥–æ–≤</div>
          <button class="ghost" id="resetBtn" title="–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å">–°–±—Ä–æ—Å</button>
        </div>

        <div class="shop" id="shop">
          <!-- —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞–≥–∞–∑–∏–Ω–∞ –Ω–∞–ø–æ–ª–Ω—è—é—Ç—Å—è JS -->
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="online" id="onlineBox" style="display:none">
        <span class="dot" id="onlineDot"></span>
        –°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω: <b id="online">‚Äî</b>
      </div>

      <div class="controls">
        <button class="ghost" id="soundBtn">üîä –ó–≤—É–∫: –≤—ã–∫–ª</button>
        <button class="ghost" id="shareBtn">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –æ—á–∫–∞–º–∏</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Ably Realtime (–¥–ª—è –æ–Ω–ª–∞–π–Ω-—Å—á—ë—Ç—á–∏–∫–∞, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>

  <script>
    // =========================
    //      GAME STATE
    // =========================
    const state = {
      score: 0,
      basePerTap: 1,
      tapMultiplier: 1,   // –º–Ω–æ–∂–∏—Ç–µ–ª—å –æ—Ç –∞–ø–≥—Ä–µ–π–¥–æ–≤
      combo: 1,           // –∂–∏–≤–æ–π –∫–æ–º–±–æ
      maxCombo: 5,
      comboDecayMs: 1800, // —Å–∫–æ–ª—å–∫–æ –¥–µ—Ä–∂–∏—Ç—Å—è –∫–æ–º–±–æ –±–µ–∑ –∫–ª–∏–∫–∞
      lastTapAt: 0,
      perSec: 0,
      level: 1,
      sound: false,
      autoClickers: 0,
      upgrades: {
        tapPlus: 0,     // +1 –∫ –±–∞–∑–æ–≤–æ–º—É —Ç–∞–ø—É
        mult: 0,        // –º–Ω–æ–∂–∏—Ç–µ–ª—å –ø–µ—Ä-—Ç–∞–ø
        autoclick: 0,   // –∞–≤—Ç–æ–∫–ª–∏–∫–µ—Ä–æ–≤
        comboCap: 0,    // –ª–∏–º–∏—Ç –∫–æ–º–±–æ
      },
    };

    const shopDefs = [
      {
        key: 'tapPlus',
        title: '–°–∏–ª—å–Ω–µ–µ –ø–∞–ª–µ—Ü (+1 –∑–∞ —Ç–∞–ø)',
        desc: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—É—é —Å–∏–ª—É –Ω–∞–∂–∞—Ç–∏–π',
        baseCost: 20,
        costGrow: 1.25,
        apply: () => { state.basePerTap += 1; },
        icon: 'üñêÔ∏è'
      },
      {
        key: 'mult',
        title: '–ú–Ω–æ–∂–∏—Ç–µ–ª—å —Ç–∞–ø–æ–≤ (x1.15)',
        desc: '–ú–Ω–æ–∂–∏—Ç –æ—á–∫–∏ –∑–∞ —Ç–∞–ø',
        baseCost: 100,
        costGrow: 1.6,
        apply: () => { state.tapMultiplier *= 1.15; },
        icon: '‚ú®'
      },
      {
        key: 'autoclick',
        title: '–ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä (+1/s)',
        desc: '–ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –¥–æ–±–∞–≤–ª—è–µ—Ç –æ—á–∫–∏',
        baseCost: 150,
        costGrow: 1.55,
        apply: () => { state.autoClickers += 1; recomputePerSec(); },
        icon: '‚öôÔ∏è'
      },
      {
        key: 'comboCap',
        title: '–ö–æ–º–±–æ-–ª–∏–º–∏—Ç (+1 –∫ –º–∞–∫—Å)',
        desc: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –∫–æ–º–±–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è',
        baseCost: 180,
        costGrow: 1.7,
        apply: () => { state.maxCombo += 1; },
        icon: 'üî•'
      },
    ];

    function costFor(key, level){
      const def = shopDefs.find(x=>x.key===key);
      return Math.floor(def.baseCost * Math.pow(def.costGrow, level));
    }

    function save(){
      localStorage.setItem('tapneo', JSON.stringify(state));
      flashSave();
    }
    function load(){
      const raw = localStorage.getItem('tapneo');
      if(!raw) return;
      try{
        const prev = JSON.parse(raw);
        Object.assign(state, prev);
      }catch(e){}
    }

    // =========================
    //      UI BINDINGS
    // =========================
    const elScore = document.getElementById('score');
    const elPerTap = document.getElementById('perTap');
    const elPerSec = document.getElementById('perSec');
    const elTap = document.getElementById('tapBtn');
    const elBurst = document.getElementById('burst');
    const elCombo = document.getElementById('combo');
    const elLevel = document.getElementById('level');
    const elShop = document.getElementById('shop');
    const elReset = document.getElementById('resetBtn');
    const elToast = document.getElementById('toast');
    const elAchv = document.getElementById('achv');
    const elSaveStatus = document.getElementById('saveStatus');
    const elSoundBtn = document.getElementById('soundBtn');
    const elShareBtn = document.getElementById('shareBtn');
    const elOnline = document.getElementById('online');
    const elOnlineBox = document.getElementById('onlineBox');
    const elOnlineDot = document.getElementById('onlineDot');

    function flashSave(){
      elSaveStatus.textContent = '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úî';
      setTimeout(()=> elSaveStatus.textContent = '–∞–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ', 1000);
    }

    function fmt(n){ return Math.floor(n).toLocaleString('ru-RU'); }

    function perTapNow(){
      return state.basePerTap * state.tapMultiplier * state.combo;
    }

    function recomputePerSec(){
      state.perSec = state.autoClickers * (state.basePerTap * 0.5); // –∞–≤—Ç–æ–∫–ª–∏–∫–µ—Ä –ø–æ–ª–æ–≤–∏–Ω–∞ –±–∞–∑–æ–≤–æ–≥–æ —É–¥–∞—Ä–∞
    }

    function render(){
      elScore.textContent = fmt(state.score);
      elPerTap.textContent = '+' + fmt(perTapNow());
      elPerSec.textContent = fmt(state.perSec);
      elCombo.textContent = 'x' + (state.combo).toFixed(1);
      elLevel.textContent = state.level;
      renderShop();
    }

    function addBubble(text, color){
      const b = document.createElement('div');
      b.className='bubble'; b.textContent = text;
      b.style.left = (40 + Math.random()*40) + '%';
      b.style.top = (40 + Math.random()*20) + '%';
      b.style.color = color || '#def';
      b.style.fontSize = (16 + Math.random()*10) + 'px';
      elBurst.appendChild(b);
      setTimeout(()=> b.remove(), 800);
    }

    function levelUpIfNeeded(){
      const need = Math.pow(10, state.level) * 100; // 100, 1000, 10000...
      if(state.score >= need){
        state.level++;
        toast(`–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å ${state.level}!`, 1800);
        unlockAchievements();
      }
    }

    function unlockAchievements(){
      const list = [];
      if(state.score >= 100) list.push('üí† 100 –æ—á–∫–æ–≤');
      if(state.score >= 1000) list.push('üí† 1000 –æ—á–∫–æ–≤');
      if(state.autoClickers >= 5) list.push('üß™ 5 –∞–≤—Ç–æ–∫–ª–∏–∫–µ—Ä–æ–≤');
      if(state.maxCombo >= 7) list.push('üî• –∫–æ–º–±–æ-–º–∞—Å—Ç–µ—Ä');
      elAchv.innerHTML = '';
      list.forEach(t=>{
        const c = document.createElement('div');
        c.className='chip'; c.textContent=t;
        elAchv.appendChild(c);
      });
    }

    // =========================
    //      TAP LOGIC
    // =========================
    function tap(){
      // combo grow
      const now = Date.now();
      const dt = now - state.lastTapAt;
      state.lastTapAt = now;
      if(dt < state.comboDecayMs) {
        state.combo = Math.min((state.combo + 0.1), state.maxCombo);
      } else {
        state.combo = 1;
      }

      const add = perTapNow();
      state.score += add;
      addBubble('+' + fmt(add), '#cfe4ff');
      levelUpIfNeeded();
      render();
      autoSaveMaybe();
      if(state.sound) playTick();
    }

    elTap.addEventListener('click', tap);
    elTap.addEventListener('keydown', (e)=>{ if(e.code==='Space' || e.code==='Enter') tap(); });

    // combo decay
    setInterval(()=>{
      if(!state.lastTapAt) return;
      if(Date.now() - state.lastTapAt > state.comboDecayMs && state.combo>1){
        state.combo = Math.max(1, +(state.combo - 0.1).toFixed(1));
        elCombo.textContent = 'x'+state.combo.toFixed(1);
      }
    }, 150);

    // =========================
    //      SHOP
    // =========================
    function renderShop(){
      elShop.innerHTML='';
      shopDefs.forEach(def=>{
        const lvl = state.upgrades[def.key] || 0;
        const price = costFor(def.key, lvl);

        const row = document.createElement('div');
        row.className='row';

        const left = document.createElement('div');
        left.innerHTML = `<div class="title">${def.icon} ${def.title}</div>
                          <div class="tiny">${def.desc}</div>
                          <div class="tiny">—É—Ä–æ–≤–µ–Ω—å: <b>${lvl}</b></div>`;

        const right = document.createElement('div');
        const btn = document.createElement('button');
        btn.textContent = `–ö—É–ø–∏—Ç—å ‚Äî ${fmt(price)}`;
        btn.disabled = state.score < price;
        btn.addEventListener('click', ()=>{
          if(state.score < price) return;
          state.score -= price;
          def.apply();
          state.upgrades[def.key] = lvl+1;
          recomputePerSec();
          render();
          toast(`–ö—É–ø–ª–µ–Ω–æ: ${def.title}`);
          autoSaveNow();
        });
        right.appendChild(btn);

        row.appendChild(left);
        row.appendChild(right);
        elShop.appendChild(row);
      });
    }

    // passive income
    setInterval(()=>{
      if(state.perSec > 0){
        state.score += state.perSec;
        addBubble('+' + fmt(state.perSec), '#72ffd2');
        levelUpIfNeeded();
        render();
        autoSaveMaybe();
      }
    }, 1000);

    // =========================
    //      SAVE / RESET
    // =========================
    let saveCooldown = false;
    function autoSaveMaybe(){
      if(saveCooldown) return;
      saveCooldown = true;
      setTimeout(()=>{ save(); saveCooldown=false; }, 700);
    }
    function autoSaveNow(){ save(); }

    elReset.addEventListener('click', ()=>{
      if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) return;
      localStorage.removeItem('tapneo');
      location.reload();
    });

    // =========================
    //    SOUND + SHARE
    // =========================
    let audioCtx, tickBuf;
    async function initAudio(){
      try{
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        // –≥–µ–Ω–µ—Ä–∏–º –∫–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫
        const dur=.06, sr=audioCtx.sampleRate, frames=sr*dur;
        const buf=audioCtx.createBuffer(1, frames, sr);
        const ch=buf.getChannelData(0);
        for(let i=0;i<frames;i++){
          const t=i/sr; ch[i]=Math.sin(2*Math.PI*880*t)*Math.exp(-18*t);
        }
        tickBuf=buf;
      }catch(e){}
    }
    function playTick(){
      if(!audioCtx || !tickBuf) return;
      const src=audioCtx.createBufferSource(); src.buffer=tickBuf;
      const gain=audioCtx.createGain(); gain.gain.value=.2;
      src.connect(gain).connect(audioCtx.destination); src.start();
    }

    elSoundBtn.addEventListener('click', async ()=>{
      if(!audioCtx){ await initAudio(); }
      state.sound = !state.sound;
      elSoundBtn.textContent = state.sound? 'üîä –ó–≤—É–∫: –≤–∫–ª' : 'üîä –ó–≤—É–∫: –≤—ã–∫–ª';
      autoSaveNow();
    });

    elShareBtn.addEventListener('click', async ()=>{
      const text = `–ú–æ–∏ –æ—á–∫–∏ –≤ Tap Game ‚Äî Neo: ${fmt(state.score)}!`;
      try{
        if(navigator.share){
          await navigator.share({text, url: location.href, title:'Tap Game ‚Äî Neo'});
        }else{
          await navigator.clipboard.writeText(text + ' ' + location.href);
          toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        }
      }catch(e){}
    });

    // =========================
    //      TOAST
    // =========================
    let toastT;
    function toast(msg, ms=1200){
      elToast.textContent = msg;
      elToast.classList.add('show');
      clearTimeout(toastT);
      toastT = setTimeout(()=> elToast.classList.remove('show'), ms);
    }

    // =========================
    //      ONLINE (ABLY)
    // =========================
    (function setupOnline(){
      // –í–°–¢–ê–í–¨ –°–í–û–ô –ö–õ–Æ–ß, –∏–Ω–∞—á–µ –±–ª–æ–∫ —Å–∫—Ä–æ–µ—Ç—Å—è
      const ABLY_KEY = 'YOUR_ABLY_KEY_HERE'; // ‚Üê –ø–æ–¥—Å—Ç–∞–≤—å —Å–≤–æ–π –∫–ª—é—á Ably –∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º
      if(!ABLY_KEY || ABLY_KEY.includes('YOUR_ABLY_KEY_HERE')){
        // —Å–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç
        elOnlineBox.style.display='none';
        return;
      }
      try{
        const ably = new Ably.Realtime({ key: ABLY_KEY });
        const ch = ably.channels.get('tapneo-online');

        const me = 'u-' + Math.random().toString(16).slice(2);
        elOnlineBox.style.display='flex';

        ably.connection.on('connected', ()=>{
          elOnlineDot.style.background = 'var(--good)';
          ch.presence.enter({ id: me }, ()=>{});
          const refresh = ()=> ch.presence.get((err, members)=>{
            if(!err && members){ elOnline.textContent = members.length; }
          });
          refresh();
          ch.presence.subscribe(['enter','leave','update'], refresh);
          window.addEventListener('beforeunload', ()=>{ try{ ch.presence.leave(); }catch(e){} });
          window.addEventListener('pagehide', ()=>{ try{ ch.presence.leave(); }catch(e){} });
        });
        ably.connection.on('disconnected', ()=>{
          elOnlineDot.style.background = '#888';
        });
      }catch(e){
        elOnlineBox.style.display='none';
      }
    })();

    // =========================
    //   TELEGRAM WEBAPP UX
    // =========================
    if (window.Telegram?.WebApp) {
      try { Telegram.WebApp.expand(); } catch(e){}
    }

    // boot
    load();
    recomputePerSec();
    render();
    unlockAchievements();
  </script>
</body>
</html>
