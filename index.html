<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>üî• Tap Fight Club</title>
  <meta name="theme-color" content="#0b1226" />
  <style>
    :root{
      --vh: 1vh; /* —Ñ–∏–∫—Å 100vh ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –≤ JS */
      --bg:#0b1226; --bg2:#0f1f4a;
      --text:#e8f0ff; --muted:#b3c0ff;
      --shadow:0 10px 30px rgba(0,0,0,.35), 0 0 40px rgba(80,140,255,.15) inset;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, var(--bg2), transparent),
        radial-gradient(900px 700px at 80% 90%, #102054, transparent),
        linear-gradient(180deg, var(--bg), var(--bg));
      color:var(--text);
      height: calc(var(--vh) * 100);   /* —Å—Ç–∞–±–∏–ª—å–Ω—ã–π fullscreen */
      overflow: hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .app{ width:min(1100px,100%); height:100%; display:flex; flex-direction:column; }

    /* Top bar */
    .topbar{ padding:12px 14px; display:flex; align-items:center; justify-content:space-between; }
    .title{ display:flex; gap:10px; align-items:center; font-weight:800; letter-spacing:.3px }
    .pill{ font-size:12px; padding:6px 10px; border-radius:999px; background:#0a1a38; color:var(--muted); border:1px solid #1a2a56; }
    .coins{ display:flex; gap:8px; align-items:center; background:#0a1a38; border:1px solid #1a2a56; padding:8px 12px; border-radius:12px; }
    .coins b{font-size:18px}

    .content{ flex:1; min-height:0; padding:0 14px 80px; }
    .card{ background:linear-gradient(180deg, rgba(20,36,80,.65), rgba(10,18,40,.65)); border:1px solid #1a2a56; border-radius:16px; box-shadow:var(--shadow); padding:16px; }
    .grid{ display:grid; grid-template-columns:1.2fr .8fr; gap:16px; height:100%; }
    @media (max-width: 880px){ .grid{ grid-template-columns:1fr; } }

    /* Tabs */
    .tabs{ position:fixed; left:0; right:0; bottom:0; display:grid; grid-template-columns:1fr 1fr 1fr; background:#0a132b; border-top:1px solid #1a2a56; padding:8px; gap:10px; }
    .tabbtn{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; padding:8px 6px; border-radius:14px; border:1px solid #1a2a56; color:var(--muted); background:#0a1a38; cursor:pointer; user-select:none; }
    .tabbtn.active{ color:#fff; box-shadow: inset 0 0 24px rgba(114,255,210,.08); border-color:#2a4a86 }
    .tabicon{ font-size:18px }

    /* Play */
    .score{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; border-radius:14px; background:rgba(10,20,48,.5); border:1px solid #1a2a56; margin-bottom:12px; }
    .big{ font-size: clamp(28px, 6.5vw, 46px); font-weight:800 }
    .muted{ color:var(--muted); font-size:13px }
    .vflex{ display:flex; flex-direction:column; gap:6px }
    .tapwrap{ height:100%; display:flex; flex-direction:column; align-items:center; gap:16px }
    .tap{
      width:min(420px, 70vmin); aspect-ratio:1/1; border-radius:34px; border:1px solid #1e3470;
      background:
        radial-gradient(200px 200px at 70% 25%, rgba(112,182,255,.25), transparent),
        radial-gradient(400px 400px at 30% 80%, rgba(114,255,210,.15), transparent),
        linear-gradient(180deg, #1a2d63, #0d1a3b);
      box-shadow: 0 25px 50px rgba(0,0,0,.35), inset 0 -6px 20px rgba(0,0,0,.35), inset 0 0 60px rgba(114,255,210,.07);
      display:grid; place-items:center; cursor:pointer; user-select:none; position:relative; transition: transform .06s ease; outline:none; margin:auto;
    }
    .tap:active{ transform: scale(.98) }
    .tap .label{ font-size: clamp(20px, 5.5vw, 28px); font-weight:800; opacity:.95; text-align:center }
    .burst{ position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .bubble{ position:absolute; font-weight:800; filter: drop-shadow(0 8px 16px rgba(0,0,0,.35)); animation: pop 700ms ease forwards; }
    @keyframes pop{ 0%{ transform: translateY(0) scale(.7); opacity:0 } 15%{ opacity:1 } 100%{ transform: translateY(-60px) scale(1.1); opacity:0 } }

    /* Shop */
    .shop .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border:1px solid #1a2a56; border-radius:12px; background:#0c1a3a7a; }
    .shop .row + .row{ margin-top:10px }
    .shop .title{ font-weight:700 } .tiny{ font-size:12px; color:var(--muted) }
    .shop button{ background: linear-gradient(180deg,#6aa3ff,#4b87ff); border:none; color:#05122c; padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; box-shadow: 0 8px 20px rgba(80,140,255,.35); min-width:96px; }
    .shop button:disabled{ filter: grayscale(1) brightness(.7); cursor:not-allowed }

    /* Quests */
    .qcard{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border:1px solid #1a2a56; border-radius:12px; background:#0c1a3a7a; }
    .qcard + .qcard{ margin-top:10px }
    .progress{ width:140px; height:8px; background:#0a1a38; border:1px solid #1a2a56; border-radius:999px; position:relative; overflow:hidden }
    .bar{ position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg, #72ffd2, #6aa3ff) }

    /* Leaderboard */
    .lbrow{ display:grid; grid-template-columns: 32px 1fr auto; gap:12px; align-items:center; padding:10px 12px; border:1px solid #1a2a56; border-radius:12px; background:#0c1a3a7a; }
    .lbrow + .lbrow{ margin-top:10px }
    .avatar{ width:32px; height:32px; border-radius:50%; background:#21356e; display:grid; place-items:center; font-weight:800 }

    /* Toast */
    .toast{ position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:#0b1a3a; border:1px solid #1a2a56; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); opacity:0; transition: opacity .2s, transform .2s; z-index:50; pointer-events:none; }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }
  </style>
</head>
<body>
  <div class="app">
    <!-- TOP -->
    <div class="topbar">
      <div class="title">ü•ä <span>Tap Fight Club</span> <span class="pill" id="saveStatus">–∞–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</span></div>
      <div class="coins">üí∞ <b id="coins">0</b></div>
    </div>

    <!-- CONTENT: PLAY -->
    <div class="content" id="tab-play" role="tabpanel">
      <div class="grid">
        <!-- LEFT -->
        <div class="card" style="display:flex; flex-direction:column">
          <div class="score">
            <div class="vflex"><div class="muted">–æ—á–∫–∏</div><div class="big" id="score">0</div></div>
            <div class="vflex"><div class="muted">–∑–∞ —Ç–∞–ø</div><div class="big" id="perTap">+1</div></div>
            <div class="vflex"><div class="muted">–≤ —Å–µ–∫.</div><div class="big" id="perSec">0</div></div>
            <div class="vflex"><div class="muted">–∫–æ–º–±–æ</div><div class="big" id="combo">x1.0</div></div>
          </div>

          <div class="tapwrap">
            <button class="tap" id="tapBtn" aria-label="–ñ–º–∏!">
              <div class="label">–ñ–ú–ò!<div class="muted" style="font-size:12px">–¥–µ—Ä–∂–∏ —Ç–µ–º–ø –¥–ª—è –∫–æ–º–±–æ</div></div>
              <div class="burst" id="burst"></div>
            </button>

            <div class="card" style="width:100%; max-width:680px">
              <div class="shop" id="shop"></div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px">
            <div style="font-weight:800">–ü—Ä–æ—Ñ–∏–ª—å</div>
            <button class="pill" id="resetBtn" title="–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å">–°–±—Ä–æ—Å</button>
          </div>
          <div class="vflex">
            <div class="qcard">
              <div class="vflex"><div class="muted">–Ω–∏–∫</div><div><b id="playerName">–≥–æ—Å—Ç—å</b></div></div>
              <button class="tabbtn" id="editName" style="grid-template-columns:unset;padding:8px 12px">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
            </div>
            <div class="qcard" id="onlineBox" style="display:none">
              <div class="vflex"><div class="muted">—Å–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω</div><div><b id="online">‚Äî</b></div></div>
              <div class="pill" id="netState">‚óè</div>
            </div>
            <div class="qcard">
              <div class="vflex"><div class="muted">—É—Ä–æ–≤–µ–Ω—å</div><div><b id="level">1</b></div></div>
              <div class="vflex"><div class="muted">–∞–ø–≥—Ä–µ–π–¥—ã</div><div><b id="upgCount">0</b></div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- QUESTS -->
    <div class="content" id="tab-quests" role="tabpanel" hidden>
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px">
          <div style="font-weight:800; font-size:18px">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</div>
          <div class="pill">—Å–±—Ä–æ—Å: <b id="resetAt">00:00</b></div>
        </div>
        <div id="quests"></div>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div class="content" id="tab-lb" role="tabpanel" hidden>
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px">
          <div style="font-weight:800; font-size:18px">–õ–∏–¥–µ—Ä–±–æ—Ä–¥</div>
          <button class="tabbtn" id="syncLB" style="grid-template-columns:unset;padding:8px 12px">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div id="lb"></div>
        <div class="muted" style="margin-top:10px">* —Å–µ–π—á–∞—Å –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ (—Ç–≤–æ–∏ –æ—á–∫–∏ + –±–æ—Ç—ã). –ì–æ—Ç–æ–≤ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–µ—Ä–≤–µ—Ä ‚Äî —Å–∫–∞–∂–∏.</div>
      </div>
    </div>

    <!-- TABS -->
    <nav class="tabs" role="tablist">
      <button class="tabbtn active" data-tab="play"><div class="tabicon">üéÆ</div>–ò–≥—Ä–∞</button>
      <button class="tabbtn" data-tab="quests"><div class="tabicon">üìã</div>–ó–∞–¥–∞–Ω–∏—è</button>
      <button class="tabbtn" data-tab="lb"><div class="tabicon">üèÜ</div>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
    </nav>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Ably (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –æ–Ω–ª–∞–π–Ω–∞) -->
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>

  <script>
    /* ===== Fullscreen & 100vh fix ===== */
    function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
    setVH(); addEventListener('resize', setVH); addEventListener('orientationchange', setVH); setTimeout(setVH, 50);

    function expandTelegram(){
      try{
        if(window.Telegram?.WebApp){
          Telegram.WebApp.ready?.();
          Telegram.WebApp.expand?.();
          Telegram.WebApp.disableVerticalSwipes?.();
          Telegram.WebApp.setHeaderColor?.('secondary_bg_color');
          Telegram.WebApp.setBackgroundColor?.('#0b1226');
        }
      }catch(e){}
    }
    expandTelegram(); document.addEventListener('DOMContentLoaded', expandTelegram);

    // –ù–∞—Ç–∏–≤–Ω—ã–π fullscreen –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–µ–π—Å—Ç–≤–∏–∏
    let fsTried=false;
    function tryFullscreenOnce(){
      if(fsTried) return; fsTried=true;
      const el=document.documentElement;
      if(el.requestFullscreen) el.requestFullscreen().catch(()=>{});
      else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    }
    document.addEventListener('click', tryFullscreenOnce, { once:true, capture:true });
    document.addEventListener('touchend', tryFullscreenOnce, { once:true, capture:true });

    /* ===== State ===== */
    const state = {
      name:'–≥–æ—Å—Ç—å', uid: 'u-'+Math.random().toString(16).slice(2),
      score:0, coins:0,
      basePerTap:1, tapMultiplier:1, combo:1, maxCombo:5, comboDecayMs:1800, lastTapAt:0,
      perSec:0, level:1, sound:false, autoClickers:0,
      upgrades:{tapPlus:0,mult:0,autoclick:0,comboCap:0},
      lastDaily:null, quests:{}, leaderboard:[]
    };

    /* ===== Elements ===== */
    const $=s=>document.querySelector(s);
    const elScore=$('#score'), elPerTap=$('#perTap'), elPerSec=$('#perSec'), elCombo=$('#combo');
    const elLevel=$('#level'), elUpgCount=$('#upgCount'), elCoins=$('#coins'), elPlayerName=$('#playerName');
    const elTap=$('#tapBtn'), elBurst=$('#burst'), elShop=$('#shop'), elToast=$('#toast');
    const elQuests=$('#quests'), elResetAt=$('#resetAt'), elLB=$('#lb');
    const elOnline=$('#online'), elOnlineBox=$('#onlineBox'), elNetState=$('#netState');

    /* ===== Save/Load ===== */
    function save(){ localStorage.setItem('tfc-save', JSON.stringify(state)); flashSave(); }
    function load(){
      try{ const raw=localStorage.getItem('tfc-save'); if(!raw) return;
        const prev=JSON.parse(raw); Object.assign(state,prev); if(!state.uid) state.uid='u-'+Math.random().toString(16).slice(2);
      }catch(e){}
    }
    function flashSave(){ $('#saveStatus').textContent='—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úî'; setTimeout(()=>$('#saveStatus').textContent='–∞–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ',1000); }
    let saveCooldown=false; function autoSaveMaybe(){ if(saveCooldown) return; saveCooldown=true; setTimeout(()=>{ save(); saveCooldown=false; },700); }
    function autoSaveNow(){ save(); }

    /* ===== Utils ===== */
    const fmt=n=>Math.floor(n).toLocaleString('ru-RU');
    const todayKey=()=>new Date().toISOString().slice(0,10);

    /* ===== Game Core ===== */
    function perTapNow(){ return state.basePerTap*state.tapMultiplier*state.combo; }
    function recomputePerSec(){ state.perSec = state.autoClickers * (state.basePerTap * 0.5); }
    function render(){
      elScore.textContent=fmt(state.score);
      elPerTap.textContent='+'+fmt(perTapNow());
      elPerSec.textContent=fmt(state.perSec);
      elCombo.textContent='x'+state.combo.toFixed(1);
      elLevel.textContent=state.level;
      elUpgCount.textContent=Object.values(state.upgrades).reduce((a,b)=>a+b,0);
      elCoins.textContent=fmt(state.coins);
      elPlayerName.textContent=state.name;
      renderShop(); renderQuests(); renderLeaderboard();
    }
    function levelUpIfNeeded(){ const need=Math.pow(10,state.level)*120; if(state.score>=need){ state.level++; toast(`–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å ${state.level}!`,1600); } }
    function addBubble(text,color){
      const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
      b.style.left=(40+Math.random()*40)+'%'; b.style.top=(40+Math.random()*20)+'%';
      b.style.color=color||'#cfe4ff'; b.style.fontSize=(16+Math.random()*10)+'px';
      elBurst.appendChild(b); setTimeout(()=>b.remove(),800);
    }
    function tap(){
      const now=Date.now(), dt=now-state.lastTapAt; state.lastTapAt=now;
      state.combo = dt<state.comboDecayMs ? Math.min(state.combo+0.12, state.maxCombo) : 1;
      const add=perTapNow();
      state.score+=add; state.coins+=Math.max(1,Math.floor(add/10));
      addBubble('+'+fmt(add));
      levelUpIfNeeded(); tickQuest('taps',1); tickQuest('earn',add);
      autoSaveMaybe(); render();
    }
    elTap.addEventListener('click', tap);
    elTap.addEventListener('keydown', e=>{ if(e.code==='Space'||e.code==='Enter') tap(); });
    setInterval(()=>{ if(!state.lastTapAt) return;
      if(Date.now()-state.lastTapAt>state.comboDecayMs && state.combo>1){ state.combo=Math.max(1,+(state.combo-0.1).toFixed(1)); elCombo.textContent='x'+state.combo.toFixed(1); }
    },150);
    setInterval(()=>{ if(state.perSec>0){ state.score+=state.perSec; state.coins+=Math.max(1,Math.floor(state.perSec/10));
      addBubble('+'+fmt(state.perSec),'#72ffd2'); levelUpIfNeeded(); tickQuest('earn',state.perSec); autoSaveMaybe(); render(); } },1000);

    /* ===== Shop ===== */
    const shopDefs=[
      {key:'tapPlus', title:'–°–∏–ª—å–Ω–µ–µ —É–¥–∞—Ä (+1 –∑–∞ —Ç–∞–ø)', desc:'–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—É—é —Å–∏–ª—É', baseCost:20,  grow:1.25, apply:()=>{state.basePerTap+=1;}},
      {key:'mult',    title:'–ú–Ω–æ–∂–∏—Ç–µ–ª—å (x1.15)',        desc:'–ú–Ω–æ–∂–∏—Ç –æ—á–∫–∏ –∑–∞ —Ç–∞–ø',       baseCost:120, grow:1.6,  apply:()=>{state.tapMultiplier*=1.15;}},
      {key:'autoclick',title:'–ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä (+1/s)',       desc:'–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥',          baseCost:180, grow:1.55, apply:()=>{state.autoClickers+=1;recomputePerSec();}},
      {key:'comboCap', title:'–ö–æ–º–±–æ-–ø—Ä–µ–¥–µ–ª (+1)',       desc:'–ú–∞–∫—Å–∏–º—É–º –∫–æ–º–±–æ ‚Üë',         baseCost:220, grow:1.7,  apply:()=>{state.maxCombo+=1;}},
    ];
    const price=(d,lvl)=>Math.floor(d.baseCost*Math.pow(d.grow,lvl||0));
    function renderShop(){
      elShop.innerHTML='';
      shopDefs.forEach(def=>{
        const lvl=state.upgrades[def.key]||0, cost=price(def,lvl);
        const row=document.createElement('div'); row.className='row';
        const left=document.createElement('div'); left.innerHTML=`<div class="title">${def.title}</div><div class="tiny">${def.desc}</div><div class="tiny">—É—Ä–æ–≤–µ–Ω—å: <b>${lvl}</b></div>`;
        const right=document.createElement('div'); const btn=document.createElement('button'); btn.textContent=`–ö—É–ø–∏—Ç—å ‚Äî ${fmt(cost)}üí∞`; btn.disabled=state.coins<cost;
        btn.addEventListener('click',()=>{ if(state.coins<cost) return; state.coins-=cost; def.apply(); state.upgrades[def.key]=lvl+1; tickQuest('buy',1); render(); autoSaveNow(); toast(`–ö—É–ø–ª–µ–Ω–æ: ${def.title}`); });
        right.appendChild(btn); row.appendChild(left); row.appendChild(right); elShop.appendChild(row);
      });
    }

    /* ===== Daily Quests ===== */
    const dailyDefs=[
      {key:'taps', title:'–°–¥–µ–ª–∞–π 200 —Ç–∞–ø–æ–≤', target:200, reward:200},
      {key:'earn', title:'–ó–∞—Ä–∞–±–æ—Ç–∞–π 5,000 –æ—á–∫–æ–≤', target:5000, reward:300},
      {key:'buy',  title:'–ö—É–ø–∏ 1 –∞–ø–≥—Ä–µ–π–¥', target:1, reward:150},
      {key:'visit',title:'–ó–∞–π–¥–∏ —Å–µ–≥–æ–¥–Ω—è –≤ –∏–≥—Ä—É', target:1, reward:100},
    ];
    function ensureDaily(){
      const today=todayKey();
      if(state.lastDaily!==today){
        state.lastDaily=today; state.quests={}; dailyDefs.forEach(q=>state.quests[q.key]={done:false,val:0}); state.quests.visit.val=1;
      }
    }
    function tickQuest(key,inc){
      ensureDaily(); const q=state.quests[key]; if(!q||q.done) return;
      q.val+=inc; const def=dailyDefs.find(d=>d.key===key);
      if(q.val>=def.target){ q.done=true; state.coins+=def.reward; toast(`–ó–∞–¥–∞–Ω–∏–µ: ¬´${def.title}¬ª ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +${def.reward}üí∞`); }
      renderQuests(); autoSaveMaybe();
    }
    function renderQuests(){
      ensureDaily(); elQuests.innerHTML='';
      const now=new Date(); const midnight=new Date(now); midnight.setHours(24,0,0,0);
      const left=midnight-now; const hh=Math.floor(left/3600000), mm=Math.floor((left%3600000)/60000);
      elResetAt.textContent=`${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
      dailyDefs.forEach(def=>{
        const q=state.quests[def.key]||{val:0,done:false}; const pct=Math.min(100,Math.floor((q.val/def.target)*100));
        const row=document.createElement('div'); row.className='qcard';
        const leftCol=document.createElement('div'); leftCol.innerHTML=`
          <div><b>${def.title}</b></div>
          <div class="tiny">–Ω–∞–≥—Ä–∞–¥–∞: +${def.reward}üí∞</div>
          <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
          <div class="tiny">${Math.min(q.val,def.target)} / ${def.target}</div>`;
        const rightCol=document.createElement('div'); const btn=document.createElement('button'); btn.className='tabbtn'; btn.style.padding='8px 12px';
        btn.textContent=q.done?'‚úì –ì–æ—Ç–æ–≤–æ':(pct>=100?'–ó–∞–±—Ä–∞—Ç—å':'–í –ø—Ä–æ—Ü–µ—Å—Å–µ'); btn.disabled=!(!q.done && pct>=100);
        btn.addEventListener('click',()=>{ if(q.done||pct<100) return; q.done=true; state.coins+=def.reward; renderQuests(); autoSaveNow(); toast(`+${def.reward}üí∞`); });
        rightCol.appendChild(btn); row.appendChild(leftCol); row.appendChild(rightCol); elQuests.appendChild(row);
      });
    }

    /* ===== Leaderboard (local) ===== */
    function seedBotsIfEmpty(){ if(!state.leaderboard||state.leaderboard.length===0){ state.leaderboard=[
      {uid:'bot1',name:'NeoHam',score:120000},{uid:'bot2',name:'Foxy',score:78000},{uid:'bot3',name:'ByteCat',score:54000},{uid:'bot4',name:'Sakura',score:31000},{uid:'bot5',name:'Rider',score:18000},
    ];}}
    function upsertSelfToLB(){
      const me={uid:state.uid,name:state.name,score:Math.floor(state.score)};
      const i=state.leaderboard.findIndex(r=>r.uid===state.uid);
      if(i>=0) state.leaderboard[i]=me; else state.leaderboard.push(me);
      state.leaderboard.sort((a,b)=>b.score-a.score); state.leaderboard=state.leaderboard.slice(0,50);
    }
    function renderLeaderboard(){
      seedBotsIfEmpty(); upsertSelfToLB(); const el=$('#lb'); el.innerHTML='';
      state.leaderboard.forEach((row,i)=>{
        const d=document.createElement('div'); d.className='lbrow'; const you=row.uid===state.uid;
        d.innerHTML=`<div>${i+1}</div>
          <div style="display:flex; align-items:center; gap:10px">
            <div class="avatar">${(row.name||'U')[0].toUpperCase()}</div>
            <div><div><b>${row.name}${you?' (—Ç—ã)':''}</b></div><div class="tiny">${you?'ID: '+state.uid:''}</div></div>
          </div>
          <div><b>${fmt(row.score)}</b></div>`;
        el.appendChild(d);
      });
    }

    /* ===== Tabs ===== */
    document.querySelectorAll('.tabbtn[data-tab]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tabbtn[data-tab]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab=btn.dataset.tab;
        document.querySelectorAll('[role="tabpanel"]').forEach(p=>p.hidden=true);
        document.getElementById('tab-'+tab).hidden=false;
      });
    });
    $('#syncLB').addEventListener('click', ()=>{ renderLeaderboard(); toast('–õ–∏–¥–µ—Ä–±–æ—Ä–¥ –æ–±–Ω–æ–≤–ª—ë–Ω'); });

    /* ===== Name / Reset ===== */
    $('#editName').addEventListener('click', ()=>{
      const v=prompt('–¢–≤–æ–π –Ω–∏–∫:', state.name||''); if(!v) return;
      state.name=v.toString().slice(0,20)||'–≥–æ—Å—Ç—å'; render(); autoSaveNow();
    });
    $('#resetBtn').addEventListener('click', ()=>{
      if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) return;
      localStorage.removeItem('tfc-save'); location.reload();
    });

    /* ===== Toast ===== */
    let toastT; function toast(msg,ms=1200){ elToast.textContent=msg; elToast.classList.add('show'); clearTimeout(toastT); toastT=setTimeout(()=>elToast.classList.remove('show'),ms); }

    /* ===== Online (Ably, optional) ===== */
    (function(){
      const ABLY_KEY='YOUR_ABLY_KEY_HERE'; // –ø–æ–¥—Å—Ç–∞–≤—å –∫–ª—é—á ‚Äî –ø–æ—è–≤–∏—Ç—Å—è –±–ª–æ–∫ ¬´–æ–Ω–ª–∞–π–Ω¬ª
      if(!ABLY_KEY || ABLY_KEY.includes('YOUR_ABLY_KEY_HERE')){ elOnlineBox.style.display='none'; return; }
      try{
        const ably=new Ably.Realtime({key:ABLY_KEY}); const ch=ably.channels.get('tfc-online'); elOnlineBox.style.display='block';
        elNetState.textContent='‚óè offline';
        ably.connection.on('connected',()=>{ elNetState.textContent='‚óè online'; elNetState.className='pill'; });
        ch.presence.enter({id:state.uid},()=>{});
        const refresh=()=>ch.presence.get((err,m)=>{ if(!err&&m){ elOnline.textContent=m.length; }});
        refresh(); ch.presence.subscribe(['enter','leave','update'],refresh);
        addEventListener('beforeunload',()=>{ try{ch.presence.leave();}catch(e){} });
        addEventListener('pagehide',()=>{ try{ch.presence.leave();}catch(e){} });
      }catch(e){ elOnlineBox.style.display='none'; }
    })();

    /* ===== Boot ===== */
    function tryGetTGName(){
      try{
        const u=window.Telegram?.WebApp?.initDataUnsafe?.user;
        if(u){ state.name = u.username || u.first_name || '–∏–≥—Ä–æ–∫'; }
        if(window.Telegram?.WebApp){ Telegram.WebApp.expand?.(); }
      }catch(e){}
    }
    load(); tryGetTGName();
    // –µ–∂–µ–¥–Ω–µ–≤–∫–∏
    (function ensureDailyInit(){ const today=todayKey(); if(state.lastDaily!==today){ state.lastDaily=today; state.quests={}; const defs=['taps','earn','buy','visit']; defs.forEach(k=>state.quests[k]={done:false,val:0}); state.quests.visit.val=1; }})();
    // —Ä–∞—Å—Å—á—ë—Ç—ã –∏ —Ä–µ–Ω–¥–µ—Ä
    (function init(){ recomputePerSec(); render(); })();

    // combo decay –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∞–ø–¥–µ–π—Ç
    setInterval(()=>{ /* no-op, —É–∂–µ –µ—Å—Ç—å —Ç–∞–π–º–µ—Ä—ã */ }, 1000);

    // share (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É)
  </script>
</body>
</html>
