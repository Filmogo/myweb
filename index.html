<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>‚≠ê Tetris Club ‚Äî Mobile</title>
<meta name="theme-color" content="#0b1226" />
<style>
  :root{ --vh:1vh; --bg:#0b1226; --bg2:#0f1f4a; --text:#e8f0ff; --muted:#a9b8ff; --line:#1a2a56; --accent:#6aa3ff; --good:#72ffa6; --warn:#ffd36a; }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  html,body{height:100%;margin:0}
  body{
    height:calc(var(--vh)*100);
    overflow:hidden;
    background:
      radial-gradient(1200px 800px at 15% 10%, var(--bg2), transparent),
      radial-gradient(900px 700px at 80% 90%, #102054, transparent),
      linear-gradient(180deg, var(--bg), var(--bg));
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Arial;
    display:flex;align-items:center;justify-content:center;
  }

  .app{ width:min(1100px,100%); height:100%; display:grid; grid-template-rows:auto 1fr auto; gap:12px; padding:12px; }

  .top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .brand{ display:flex; gap:10px; align-items:center; font-weight:900; letter-spacing:.3px }
  .stat{ display:flex; gap:8px; flex-wrap:wrap; }
  .pill{ font-size:12px; padding:6px 10px; border-radius:999px; background:#0a1a38; color:var(--muted); border:1px solid var(--line); }
  .pill b{color:#fff}

  .main{ display:grid; grid-template-columns: minmax(260px, 1fr) 360px; gap:12px; height:100%; }
  @media (max-width: 900px){ .main{ grid-template-columns:1fr; } }

  .board{
    position:relative; margin:auto; width:min(90vw, 480px); aspect-ratio: 10/20;
    background:#0a1633; border:1px solid var(--line); border-radius:12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 40px rgba(114,255,210,.05);
    overflow:hidden;
  }
  canvas{ width:100%; height:100%; display:block; image-rendering: pixelated; touch-action:none; }

  .side{ display:flex; flex-direction:column; gap:12px; height:100%; }
  .card{
    background: linear-gradient(180deg, rgba(20,36,80,.55), rgba(10,18,40,.55));
    border:1px solid var(--line); border-radius:12px; padding:12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.3);
  }
  .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .next{ display:grid; grid-template-columns:repeat(4,18px); grid-auto-rows:18px; gap:2px; padding:8px; background:#0a1a38; border:1px solid var(--line); border-radius:8px; width:max-content }
  .cell{ width:18px; height:18px; background:#142a5a; border-radius:4px; }

  .btn{ padding:10px 12px; border:none; border-radius:10px; font-weight:800; cursor:pointer; }
  .primary{ background:linear-gradient(180deg,#6aa3ff,#4b87ff); color:#05122c; }
  .ghost{ background:transparent; border:1px solid var(--line); color:var(--muted); }
  .danger{ background:linear-gradient(180deg,#ff869e,#ff6a89); color:#2b0511; }
  .ok{ background:linear-gradient(180deg,#76ffb0,#39d681); color:#05301a; }

  .shop-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; border:1px solid var(--line); border-radius:10px; padding:10px; background:#0b1b3d; }
  .tiny{ font-size:12px; color:var(--muted) }

  .tabs{ position:fixed; left:0; right:0; bottom:0; display:grid; grid-template-columns:1fr 1fr 1fr; background:#0a132b; border-top:1px solid var(--line); padding:8px; gap:10px; }
  .tabbtn{ display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px 6px; border-radius:12px; border:1px solid var(--line); background:#0a1a38; color:var(--muted); font-weight:700; cursor:pointer; }
  .tabbtn.active{ color:#fff; border-color:#2a4a86; box-shadow: inset 0 0 24px rgba(114,255,210,.08) }

  /* –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
  .controls{
    position:absolute; left:0; right:0; bottom:6px; display:flex; justify-content:space-between; padding:8px;
    pointer-events:none;
  }
  .ctrlgroup{ display:flex; gap:8px; }
  .ctrlbtn{ pointer-events:auto; background:#0a1a38; border:1px solid var(--line); color:#fff; border-radius:12px; padding:10px 12px; font-weight:900; opacity:.95 }
  .ctrlbtn:active{ transform:scale(.97) }

  /* –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω */
  .overlay{
    position:absolute; inset:0; display:grid; place-items:center; background:rgba(5,10,25,.6); backdrop-filter: blur(4px);
  }
  .modal{
    background:#0a1a38; border:1px solid var(--line); border-radius:16px; padding:16px; width:min(420px,90vw);
    text-align:center; box-shadow: 0 20px 60px rgba(0,0,0,.5);
  }

  .toast{ position:fixed; left:50%; bottom:22px; transform:translateX(-50%) translateY(20px); background:#0b1a3a; border:1px solid var(--line); padding:10px 14px; border-radius:12px; opacity:0; transition: opacity .2s, transform .2s; pointer-events:none; }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }
</style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">üß© <span>Tetris Club</span></div>
      <div class="stat">
        <div class="pill">—É—Ä–æ–≤–µ–Ω—å: <b id="level">1</b></div>
        <div class="pill">–æ—á–∫–∏: <b id="score">0</b></div>
        <div class="pill">‚≠ê –∑–≤—ë–∑–¥—ã: <b id="stars">0</b></div>
        <div class="pill">–∑–∞–º–µ–¥–ª–µ–Ω–∏—è: <b id="slowCharges">0</b></div>
      </div>
    </div>

    <div class="main">
      <!-- –ò–ì–†–û–í–û–ï –ü–û–õ–ï -->
      <div class="board" id="board">
        <canvas id="game" width="200" height="400"></canvas>

        <!-- –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
        <div class="overlay" id="startOverlay">
          <div class="modal">
            <h3 style="margin:6px 0 10px">Tetris Club</h3>
            <div class="tiny" style="margin-bottom:10px">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ‚Üê/‚Üí, ‚Üë (–ø–æ–≤–æ—Ä–æ—Ç), ‚Üì, Space (—Ö–∞—Ä–¥-–¥—Ä–æ–ø). –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ ‚Äî –∫–Ω–æ–ø–∫–∏ –∏ —Å–≤–∞–π–ø—ã.</div>
            <button class="btn ok" id="startBtn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
          </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
        <div class="controls">
          <div class="ctrlgroup">
            <button class="ctrlbtn" id="leftBtn">‚Üê</button>
            <button class="ctrlbtn" id="rightBtn">‚Üí</button>
            <button class="ctrlbtn" id="rotateBtn">‚§æ</button>
          </div>
          <div class="ctrlgroup">
            <button class="ctrlbtn" id="downBtn">‚Üì</button>
            <button class="ctrlbtn" id="dropBtn">‚§ì</button>
            <button class="ctrlbtn" id="pauseBtn">‚è∏</button>
          </div>
        </div>
      </div>

      <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
      <div class="side">
        <!-- –ö–æ–Ω—Ç—Ä–æ–ª—å -->
        <div class="card">
          <div class="row" style="margin-bottom:8px"><div><b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</b></div></div>
          <div class="tiny">‚Üê/‚Üí ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ, ‚Üë ‚Äî –ø–æ–≤–æ—Ä–æ—Ç, ‚Üì ‚Äî —É—Å–∫–æ—Ä–µ–Ω–∏–µ, Space ‚Äî —Ö–∞—Ä–¥-–¥—Ä–æ–ø, P/‚è∏ ‚Äî –ø–∞—É–∑–∞</div>
          <div class="row" style="margin-top:10px">
            <div class="row" style="gap:8px">
              <div class="tiny">–°–ª–µ–¥—É—é—â–∞—è —Ñ–∏–≥—É—Ä–∞:</div>
              <div class="next" id="nextBox"></div>
            </div>
            <button class="btn primary" id="slowBtn" disabled>üê¢ –ó–∞–º–µ–¥–ª–∏—Ç—å (60—Å)</button>
          </div>
        </div>

        <!-- –ú–∞–≥–∞–∑–∏–Ω -->
        <div class="card">
          <div class="row" style="margin-bottom:8px"><div><b>–ú–∞–≥–∞–∑–∏–Ω</b></div></div>
          <div class="shop-row">
            <div>
              <div><b>üê¢ –ó–∞—Ä—è–¥ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è</b></div>
              <div class="tiny">–ó–∞–º–µ–¥–ª—è–µ—Ç –ø–∞–¥–µ–Ω–∏–µ –Ω–∞ 60 —Å–µ–∫</div>
              <div class="tiny">–¶–µ–Ω–∞: <b>30‚≠ê</b></div>
            </div>
            <button class="btn primary" id="buySlowBtn">–ö—É–ø–∏—Ç—å –∑–∞ 30‚≠ê</button>
          </div>
          <div class="shop-row">
            <div>
              <div><b>‚≠ê –ö—É–ø–∏—Ç—å –∑–≤—ë–∑–¥—ã</b></div>
              <div class="tiny">–†–µ–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (Telegram invoice) ‚Äî –∑–≤—ë–∑–¥—ã –Ω–∞ –±–∞–ª–∞–Ω—Å</div>
            </div>
            <button class="btn ok" id="buyStarsBtn">–ö—É–ø–∏—Ç—å ‚≠ê</button>
          </div>
        </div>

        <!-- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ -->
        <div class="card">
          <div class="row" style="margin-bottom:8px">
            <div><b>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</b></div>
            <button class="btn ghost" id="syncLB">‚Üª</button>
          </div>
          <div id="lb"></div>
        </div>
      </div>
    </div>

    <!-- –¢–ê–ë–´ (–¥–ª—è —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤) -->
    <div class="tabs">
      <button class="tabbtn active" data-tab="play">üéÆ –ò–≥—Ä–∞</button>
      <button class="tabbtn" data-tab="shop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
      <button class="tabbtn" data-tab="lb">üèÜ –õ–∏–¥–µ—Ä—ã</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  /* ===== –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω & Telegram WebApp ===== */
  function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
  setVH(); addEventListener('resize', setVH); addEventListener('orientationchange', setVH); setTimeout(setVH, 50);
  function tgExpand(){ try{ if(window.Telegram?.WebApp){ Telegram.WebApp.ready?.(); Telegram.WebApp.expand?.(); Telegram.WebApp.disableVerticalSwipes?.(); } }catch(e){} }
  tgExpand(); document.addEventListener('DOMContentLoaded', tgExpand);

  /* ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–ª–∞—Ç—ã (Telegram Invoice) =====
     –ï—Å–ª–∏ —É —Ç–µ–±—è –≥–æ—Ç–æ–≤–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–Ω–≤–æ–π—Å (—Å–æ–∑–¥–∞—ë—Ç—Å—è –±–æ—Ç–æ–º), –≤—Å—Ç–∞–≤—å –µ—ë –Ω–∏–∂–µ.
     –í Telegram –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∫–Ω–æ–ø–∫–∞ ¬´–ö—É–ø–∏—Ç—å ‚≠ê¬ª –æ—Ç–∫—Ä–æ–µ—Ç –∏–Ω–≤–æ–π—Å –∏ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ –¥–æ–±–∞–≤–∏—Ç –∑–≤—ë–∑–¥—ã –∫ –±–∞–ª–∞–Ω—Å—É.
  */
  const INVOICE_URL = ""; // –ø—Ä–∏–º–µ—Ä: "https://t.me/your_bot?start=invoice_abc123"

  /* ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —ç–ª–µ–º–µ–Ω—Ç—ã ===== */
  const $=s=>document.querySelector(s);
  const elCanvas=$('#game'), ctx=elCanvas.getContext('2d');
  const elLevel=$('#level'), elScore=$('#score'), elStars=$('#stars'), elSlowCharges=$('#slowCharges');
  const elNext=$('#nextBox'), elLB=$('#lb'), elSyncLB=$('#syncLB'), elToast=$('#toast');

  const elStartOverlay=$('#startOverlay'), elStartBtn=$('#startBtn');
  const elLeft=$('#leftBtn'), elRight=$('#rightBtn'), elRotate=$('#rotateBtn'), elDown=$('#downBtn'), elDrop=$('#dropBtn'), elPause=$('#pauseBtn');

  const elSlow=$('#slowBtn'), elBuySlow=$('#buySlowBtn'), elBuyStars=$('#buyStarsBtn');

  const W=10, H=20, CELL=20; // –∫–∞–Ω–≤–∞—Å 200x400
  const COLORS={ I:'#72ffd2', J:'#6aa3ff', L:'#ffd36a', O:'#72ffa6', S:'#ffad6a', T:'#e6a8ff', Z:'#ff6a89' };
  const SHAPES={
    I:[[1,1,1,1]],
    J:[[1,0,0],[1,1,1]],
    L:[[0,0,1],[1,1,1]],
    O:[[1,1],[1,1]],
    S:[[0,1,1],[1,1,0]],
    T:[[0,1,0],[1,1,1]],
    Z:[[1,1,0],[0,1,1]],
  };
  const PIECES=Object.keys(SHAPES);

  /* ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
  const state = {
    grid: createGrid(W,H),
    cur: null,
    next: randPiece(),
    level: +(localStorage.getItem('tetris-level')||1),
    score: +(localStorage.getItem('tetris-score')||0),
    stars: +(localStorage.getItem('tetris-stars')||0),
    slowCharges: +(localStorage.getItem('tetris-slow')||0),
    hi: +(localStorage.getItem('tetris-hi')||0),
    uid: localStorage.getItem('tetris-uid') || ('u-'+Math.random().toString(16).slice(2)),
    name: localStorage.getItem('tetris-name') || '–∏–≥—Ä–æ–∫',
    paused:true,
    over:false,
    started:false,
    tickBase: 800,
    tickSlow: 1400,
    slowActive:false,
    slowUntil:0,
    lastFall:0,
    touch:{x:0,y:0,active:false},
  };
  saveAll();

  /* ===== –£—Ç–∏–ª–∏—Ç—ã ===== */
  function createGrid(w,h){ return Array.from({length:h},()=>Array(w).fill(null)); }
  function randPiece(){ const t = PIECES[Math.floor(Math.random()*PIECES.length)]; return {type:t, mtx:copyMtx(SHAPES[t]), color:COLORS[t]}; }
  function copyMtx(m){ return m.map(r=>r.slice()); }
  function rotate(mtx){ const h=mtx.length, w=mtx[0].length; const out=Array.from({length:w},()=>Array(h).fill(0)); for(let y=0;y<h;y++) for(let x=0;x<w;x++) out[x][h-1-y]=mtx[y][x]; return out; }

  function collide(grid, piece){
    const {x,y,mtx}=piece;
    for (let j=0;j<mtx.length;j++){
      for (let i=0;i<mtx[j].length;i++){
        if (!mtx[j][i]) continue;
        const gx = x+i, gy = y+j;
        // –≤—ã—Ö–æ–¥ –∑–∞ –Ω–∏–∑ –∏–ª–∏ –±–æ–∫–∞ ‚Äî –∫–æ–ª–ª–∏–∑–∏—è
        if (gx<0 || gx>=W || gy>=H) return true;
        // –≤–µ—Ä—Ö –∑–∞ —ç–∫—Ä–∞–Ω –¥–æ–ø—É—Å–∫–∞–µ–º, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ gy>=0 —É—á–∏—Ç—ã–≤–∞–µ–º —Å–µ—Ç–∫—É
        if (gy>=0 && grid[gy][gx]) return true;
      }
    }
    return false;
  }
  function merge(grid, piece){
    const {x,y,mtx,color}=piece;
    for (let j=0;j<mtx.length;j++)
      for (let i=0;i<mtx[j].length;i++)
        if (mtx[j][i] && y+j>=0) grid[y+j][x+i] = color;
  }
  function clearLines(){
    let cleared=0;
    for (let y=H-1;y>=0;){
      if (state.grid[y].every(Boolean)){
        state.grid.splice(y,1);
        state.grid.unshift(Array(W).fill(null));
        cleared++;
      }else y--;
    }
    if (cleared){
      const table=[0,100,300,500,800];
      const add=(table[cleared]||1000)*state.level;
      state.score+=add;
      if (state.score>state.hi) state.hi=state.score;
      saveAll(); renderUI();
      levelUpCheck();
    }
  }
  function levelUpCheck(){
    const need = state.level*2000;
    if (state.score>=need){
      state.level++; state.stars+=3; toast(`–£—Ä–æ–≤–µ–Ω—å ${state.level}! ‚≠ê+3`); saveAll(); renderUI();
    }
  }
  function newPiece(){
    state.cur = { x: Math.floor(W/2)-2, y:-2, ...state.next };
    state.next = randPiece();
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ–∏–≥—Ä—ã—à (—Ñ–∏–≥—É—Ä–∞ —É–ø–∏—Ä–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É)
    if (collide(state.grid, state.cur)){
      state.over=true; state.paused=true; state.started=false;
      upsertSelfToLB(); renderLB();
      showStart();
    }
    drawNext();
  }

  /* ===== –†–µ–Ω–¥–µ—Ä ===== */
  function draw(){
    ctx.fillStyle='#0a1633';
    ctx.fillRect(0,0,elCanvas.width,elCanvas.height);

    for(let y=0;y<H;y++){
      for(let x=0;x<W;x++){
        const c=state.grid[y][x];
        if (c) drawCell(x,y,c);
        else {
          ctx.strokeStyle='rgba(26,42,86,.18)';
          ctx.strokeRect(x*CELL,y*CELL,CELL,CELL);
        }
      }
    }
    if (state.cur){
      const {x,y,mtx,color}=state.cur;
      for(let j=0;j<mtx.length;j++)
        for(let i=0;i<mtx[j].length;i++)
          if (mtx[j][i] && y+j>=0) drawCell(x+i,y+j,color);
    }

    if (state.slowActive){
      const left = Math.max(0, state.slowUntil - performance.now());
      ctx.fillStyle='rgba(114,255,166,.08)'; ctx.fillRect(0,0,elCanvas.width,elCanvas.height);
      ctx.fillStyle='#72ffa6'; ctx.font='bold 12px system-ui'; ctx.fillText(`–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ: ${(left/1000).toFixed(0)}—Å`, 6, 14);
      if (left<=0){ state.slowActive=false; elSlow.disabled = state.slowCharges<=0; }
    }
  }
  function drawCell(x,y,color){
    ctx.fillStyle=color; ctx.fillRect(x*CELL,y*CELL,CELL,CELL);
    ctx.fillStyle='rgba(255,255,255,.15)'; ctx.fillRect(x*CELL,y*CELL,CELL,4);
    ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.strokeRect(x*CELL,y*CELL,CELL,CELL);
  }
  function drawNext(){
    elNext.innerHTML='';
    const m=state.next.mtx, h=m.length, w=m[0].length;
    for(let y=0;y<4;y++) for(let x=0;x<4;x++){
      const cell=document.createElement('div'); cell.className='cell';
      if (y<h && x<w && m[y][x]) cell.style.background=state.next.color;
      elNext.appendChild(cell);
    }
  }
  function renderUI(){
    elLevel.textContent=state.level;
    elScore.textContent=state.score.toLocaleString('ru-RU');
    elStars.textContent=state.stars;
    elSlowCharges.textContent=state.slowCharges;
    elSlow.disabled = state.slowCharges<=0 || state.slowActive || !state.started;
  }
  function toast(msg,ms=1200){ elToast.textContent=msg; elToast.classList.add('show'); clearTimeout(toast._t); toast._t=setTimeout(()=>elToast.classList.remove('show'),ms); }

  /* ===== –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª ===== */
  function gravityDelay(){
    const base = state.slowActive ? state.tickSlow : state.tickBase;
    const lvFactor = Math.max(0.15, 1 - (state.level-1)*0.08);
    return Math.floor(base * lvFactor);
  }
  function step(ts){
    if (!state.started){ draw(); requestAnimationFrame(step); return; }
    if (state.paused || state.over){ draw(); requestAnimationFrame(step); return; }
    if (!state.lastFall) state.lastFall=ts;

    const delay=gravityDelay();
    if (ts - state.lastFall >= delay){
      state.lastFall = ts;
      state.cur.y++;
      if (collide(state.grid,state.cur)){
        state.cur.y--;
        merge(state.grid,state.cur); clearLines(); newPiece();
      }
    }
    draw();
    requestAnimationFrame(step);
  }

  /* ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞) ===== */
  function move(dx){
    if (!state.started || state.paused || state.over) return;
    state.cur.x+=dx; if (collide(state.grid,state.cur)) state.cur.x-=dx;
  }
  function rotateCur(){
    if (!state.started || state.paused || state.over) return;
    const prev=state.cur.mtx; state.cur.mtx=rotate(prev);
    if (collide(state.grid,state.cur)){
      state.cur.x++; if (collide(state.grid,state.cur)){
        state.cur.x-=2; if (collide(state.grid,state.cur)){
          state.cur.x++; state.cur.mtx=prev;
        }
      }
    }
  }
  function softDrop(){
    if (!state.started || state.paused || state.over) return;
    state.cur.y++; if (collide(state.grid,state.cur)) state.cur.y--; else { state.score+=1; renderUI(); }
  }
  function hardDrop(){
    if (!state.started || state.paused || state.over) return;
    let dist=0; while(true){ state.cur.y++; if (collide(state.grid,state.cur)){ state.cur.y--; break; } dist++; }
    state.score+=2*dist; renderUI(); merge(state.grid,state.cur); clearLines(); newPiece(); draw();
  }
  function togglePause(){ if (!state.started) return; state.paused=!state.paused; elPause.textContent=state.paused?'‚ñ∂Ô∏è':'‚è∏'; }
  addEventListener('keydown', e=>{
    if (e.code==='ArrowLeft') move(-1);
    else if (e.code==='ArrowRight') move(1);
    else if (e.code==='ArrowUp') rotateCur();
    else if (e.code==='ArrowDown') softDrop();
    else if (e.code==='Space'){ e.preventDefault(); hardDrop(); }
    else if (e.code==='KeyP') togglePause();
  });

  /* ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–∫–Ω–æ–ø–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ) ===== */
  elLeft.onclick = ()=> move(-1);
  elRight.onclick = ()=> move(1);
  elRotate.onclick = ()=> rotateCur();
  elDown.onclick = ()=> softDrop();
  elDrop.onclick = ()=> hardDrop();
  elPause.onclick = ()=> togglePause();

  /* ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (—Å–≤–∞–π–ø—ã/—Ç–∞–ø—ã –ø–æ –ø–æ–ª—é) ===== */
  elCanvas.addEventListener('touchstart', e=>{
    const t=e.changedTouches[0]; state.touch={x:t.clientX,y:t.clientY,active:true,ts:Date.now()}; e.preventDefault();
  }, {passive:false});
  elCanvas.addEventListener('touchmove', e=>{
    if(!state.touch.active) return;
    const t=e.changedTouches[0]; const dx=t.clientX-state.touch.x; const dy=t.clientY-state.touch.y;
    // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å–≤–∞–π–ø—ã: —à–∞–≥–∏
    if (Math.abs(dx)>30 && Math.abs(dx)>Math.abs(dy)){
      if (dx>0) move(1); else move(-1);
      state.touch.x=t.clientX; state.touch.y=t.clientY;
    }
    // –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –≤–Ω–∏–∑ ‚Äî —É—Å–∫–æ—Ä–µ–Ω–∏–µ
    if (dy>28) { softDrop(); state.touch.x=t.clientX; state.touch.y=t.clientY; }
    e.preventDefault();
  }, {passive:false});
  elCanvas.addEventListener('touchend', e=>{
    const dt = Date.now() - (state.touch.ts||0);
    const t=e.changedTouches[0];
    const dx=Math.abs(t.clientX-state.touch.x0||0), dy=Math.abs(t.clientY-state.touch.y0||0);
    // –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–ø = –ø–æ–≤–æ—Ä–æ—Ç, –¥–æ–ª–≥–∏–π (>400ms) = —Ö–∞—Ä–¥-–¥—Ä–æ–ø
    if (dt<350) rotateCur(); else hardDrop();
    state.touch.active=false;
    e.preventDefault();
  }, {passive:false});
  // —Ñ–∏–∫—Å–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ dt
  elCanvas.addEventListener('touchstart', e=>{ const t=e.changedTouches[0]; state.touch.x0=t.clientX; state.touch.y0=t.clientY; }, {passive:true});

  /* ===== –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ ===== */
  elSlow.onclick = ()=>{
    if (state.slowCharges<=0 || state.slowActive || !state.started) return;
    state.slowCharges--; state.slowActive=true; state.slowUntil=performance.now()+60000;
    toast('–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –Ω–∞ 60 —Å–µ–∫—É–Ω–¥'); saveAll(); renderUI();
  };

  /* ===== –ú–∞–≥–∞–∑–∏–Ω ===== */
  elBuySlow.onclick = ()=>{
    if (state.stars<30){ toast('–ù—É–∂–Ω–æ 30‚≠ê'); return; }
    state.stars-=30; state.slowCharges++; toast('–ö—É–ø–ª–µ–Ω –∑–∞—Ä—è–¥ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è üê¢'); saveAll(); renderUI();
  };

  // –ü–æ–∫—É–ø–∫–∞ –∑–≤—ë–∑–¥ –∑–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏ —á–µ—Ä–µ–∑ Telegram Invoice (–µ—Å–ª–∏ INVOICE_URL —É–∫–∞–∑–∞–Ω)
  elBuyStars.onclick = async ()=>{
    if (window.Telegram?.WebApp && INVOICE_URL){
      try{
        Telegram.WebApp.openInvoice(INVOICE_URL, (status)=>{
          // –í–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã: 'paid', 'cancelled', 'failed', 'pending'
          if (status==='paid'){
            // –∑–¥–µ—Å—å –æ–±—ã—á–Ω–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–ª–∞—Ç—ë–∂ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥
            // –¥–µ–º–æ: –¥–æ–±–∞–≤–∏–º 50‚≠ê
            state.stars += 50; toast('–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞: +50‚≠ê'); saveAll(); renderUI();
          } else if (status==='cancelled'){ toast('–ü–æ–∫—É–ø–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞'); }
          else if (status==='failed'){ toast('–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞'); }
        });
      }catch(e){ toast('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã'); }
    } else {
      // –î–ï–ú–û-—Ä–µ–∂–∏–º –≤–Ω–µ Telegram: –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏–º —Ç–µ—Å—Ç–æ–≤—ã–µ ‚≠ê
      state.stars += 20; toast('–î–µ–º–æ-–ø–æ–∫—É–ø–∫–∞: +20‚≠ê (–±–µ–∑ –æ–ø–ª–∞—Ç—ã)'); saveAll(); renderUI();
    }
  };

  /* ===== –õ–∏–¥–µ—Ä–±–æ—Ä–¥ (–ª–æ–∫–∞–ª—å–Ω—ã–π) ===== */
  function seedBots(){
    const bots=[{uid:'b1',name:'NeoHam',score:18000},{uid:'b2',name:'Foxy',score:12400},{uid:'b3',name:'ByteCat',score:9300},{uid:'b4',name:'Sakura',score:6800},{uid:'b5',name:'Rider',score:4700}];
    localStorage.setItem('tetris-bots', JSON.stringify(bots)); return bots;
  }
  function getLB(){
    const bots = JSON.parse(localStorage.getItem('tetris-bots')||'null') || seedBots();
    const me = { uid: state.uid, name: state.name, score: state.hi||state.score };
    const list = bots.slice(); const i=list.findIndex(r=>r.uid===me.uid); if(i>=0) list[i]=me; else list.push(me);
    list.sort((a,b)=>b.score-a.score); return list.slice(0,20);
  }
  function upsertSelfToLB(){ const list=getLB(); localStorage.setItem('tetris-lb', JSON.stringify(list)); }
  function renderLB(){
    const list=getLB(); elLB.innerHTML='';
    list.forEach((row,i)=>{
      const el=document.createElement('div'); el.className='lbrow'; const you=row.uid===state.uid;
      el.innerHTML=`<div>${i+1}</div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="avatar">${(row.name||'U')[0].toUpperCase()}</div>
          <div><div><b>${row.name}${you?' (—Ç—ã)':''}</b></div><div class="tiny">${you?('ID: '+state.uid):''}</div></div>
        </div>
        <div><b>${row.score.toLocaleString('ru-RU')}</b></div>`;
      elLB.appendChild(el);
    });
  }
  elSyncLB.onclick=()=>{ upsertSelfToLB(); renderLB(); toast('–õ–∏–¥–µ—Ä–±–æ—Ä–¥ –æ–±–Ω–æ–≤–ª—ë–Ω'); };

  /* ===== –¢–∞–±—ã (–¥–ª—è –º–æ–±–∏–ª—ã) ===== */
  document.querySelectorAll('.tabbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t=btn.dataset.tab;
      document.querySelectorAll('.side .card').forEach((c,i)=> c.style.display = (t==='play'&&i===0)||(t==='shop'&&i===1)||(t==='lb'&&i===2) ? 'block' : 'none');
    });
  });
  (function initTabs(){ const cards=document.querySelectorAll('.side .card'); cards.forEach((c,i)=> c.style.display = i===0 ? 'block' : (innerWidth<900 ? 'none' : 'block')); })();

  /* ===== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ===== */
  function saveAll(){
    localStorage.setItem('tetris-level', state.level);
    localStorage.setItem('tetris-score', state.score);
    localStorage.setItem('tetris-stars', state.stars);
    localStorage.setItem('tetris-slow', state.slowCharges);
    localStorage.setItem('tetris-hi', state.hi);
    localStorage.setItem('tetris-uid', state.uid);
    localStorage.setItem('tetris-name', state.name);
  }

  /* ===== –°—Ç–∞—Ä—Ç/—Ä–µ—Å—Ç–∞—Ä—Ç ===== */
  function resetGrid(){ state.grid=createGrid(W,H); }
  function showStart(){ elStartOverlay.style.display='grid'; }
  function hideStart(){ elStartOverlay.style.display='none'; }

  function startGame(){
    resetGrid();
    state.over=false; state.paused=false; state.started=true;
    state.score=0; state.lastFall=0; state.slowActive=false;
    newPiece(); renderUI(); draw();
  }
  elStartBtn.onclick = ()=>{ hideStart(); startGame(); };

  /* ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===== */
  drawNext(); renderUI(); renderLB(); showStart(); requestAnimationFrame(step);
</script>
</body>
</html>
